<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>luxpy.color.cri.utils.helpers &mdash; LuxPy 1.11.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b76e3c8a" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=6cf1fb80"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            LuxPy
          </a>
              <div class="version">
                1.11.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../license.html">License: GPLv3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../required_packages.html">Imported (required) packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../luxpy_structure.html">Luxpy package structure</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">LuxPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">luxpy.color.cri.utils.helpers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for luxpy.color.cri.utils.helpers</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">########################################################################</span>
<span class="c1"># &lt;LUXPY: a Python package for lighting and color science.&gt;</span>
<span class="c1"># Copyright (C) &lt;2017&gt;  &lt;Kevin A.G. Smet&gt; (ksmet1977 at gmail.com)</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module with color rendition, fidelity and gamut area helper functions</span>
<span class="sd">=====================================================================</span>

<span class="sd"> :_get_hue_bin_data(): Slice gamut spanned by the sample jabt, jabr and calculate hue-bin data.</span>

<span class="sd"> :_hue_bin_data_to_rxhj(): Calculate hue bin measures: Rcshj, Rhshj, Rfhj, DEhj</span>
<span class="sd">     </span>
<span class="sd"> :_hue_bin_data_to_rfi(): Get sample color differences DEi and calculate color fidelity values Rfi.</span>

<span class="sd"> :_hue_bin_data_to_rg():  Calculates gamut area index, Rg.</span>

<span class="sd"> :spd_to_jab_t_r(): Calculates jab color values for a sample set illuminated</span>
<span class="sd">                    with test source and its reference illuminant.</span>

<span class="sd"> :spd_to_rg(): Calculates the color gamut index of spectral data </span>
<span class="sd">               for a sample set illuminated with test source (data) </span>
<span class="sd">               with respect to some reference illuminant.</span>

<span class="sd"> :spd_to_DEi(): Calculates color difference (~fidelity) of spectral data </span>
<span class="sd">                between sample set illuminated with test source (data) </span>
<span class="sd">                and some reference illuminant.</span>

<span class="sd"> :optimize_scale_factor(): Optimize scale_factor of cri-model in cri_type </span>
<span class="sd">                           such that average Rf for a set of light sources is </span>
<span class="sd">                           the same as that of a target-cri (default: &#39;ciera&#39;)</span>

<span class="sd"> :spd_to_cri(): Calculates the color rendering fidelity index </span>
<span class="sd">                (CIE Ra, CIE Rf, IES Rf, CRI2012 Rf) of spectral data. </span>
<span class="sd">                Can also output Rg, Rfhi, Rcshi, Rhshi, cct, duv, ...</span>

<span class="sd">.. codeauthor:: Kevin A.G. Smet (ksmet1977 at gmail.com)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">luxpy</span> <span class="kn">import</span> <span class="p">(</span><span class="n">_S_INTERP_TYPE</span><span class="p">,</span> <span class="n">_IESTM3015</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">_CRI_RFL</span><span class="p">,</span>
                   <span class="n">colortf</span><span class="p">,</span> <span class="n">spd_to_xyz</span><span class="p">,</span> <span class="n">cie_interp</span><span class="p">,</span> <span class="n">cri_ref</span><span class="p">,</span> <span class="n">xyz_to_cct</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">luxpy.utils</span> <span class="kn">import</span> <span class="n">np2d</span> 
<span class="c1">#from luxpy.color.cri.utils.DE_scalers import linear_scale, log_scale, psy_scale</span>

<span class="kn">from</span> <span class="nn">luxpy.color.cri.utils.init_cri_defaults_database</span> <span class="kn">import</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span> <span class="n">_CRI_DEFAULTS</span><span class="p">,</span> <span class="n">process_cri_type_input</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_get_hue_bin_data&#39;</span><span class="p">,</span><span class="s1">&#39;spd_to_jab_t_r&#39;</span><span class="p">,</span><span class="s1">&#39;spd_to_rg&#39;</span><span class="p">,</span> <span class="s1">&#39;spd_to_DEi&#39;</span><span class="p">,</span> 
           <span class="s1">&#39;optimize_scale_factor&#39;</span><span class="p">,</span><span class="s1">&#39;spd_to_cri&#39;</span><span class="p">,</span>
           <span class="s1">&#39;_hue_bin_data_to_rxhj&#39;</span><span class="p">,</span> <span class="s1">&#39;_hue_bin_data_to_rfi&#39;</span><span class="p">,</span> <span class="s1">&#39;_hue_bin_data_to_rg&#39;</span><span class="p">]</span>

<span class="n">_CCT_MODE</span> <span class="o">=</span> <span class="s1">&#39;ohno2014&#39;</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_get_hue_bin_data_individual_samples</span><span class="p">(</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span> <span class="n">normalized_chroma_ref</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper function to return dict with required keys when nhbins = None in call to _get_hue_bin_data&quot;&quot;&quot;</span>
    
    <span class="c1"># get hues of jabt, jabr:</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">htype</span> <span class="o">=</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">htype</span> <span class="o">=</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get chroma of jabt, jabr:</span>
    <span class="n">Ct</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Cr</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    
    
    <span class="c1"># Calculate DEi between jabt, jabr:</span>
    <span class="n">DEi</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt</span> <span class="o">-</span> <span class="n">jabr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    
    <span class="n">jabt_hj</span><span class="p">,</span> <span class="n">jabr_hj</span><span class="p">,</span> <span class="n">DE_hj</span> <span class="o">=</span> <span class="n">jabt</span><span class="p">,</span> <span class="n">jabr</span><span class="p">,</span> <span class="n">DEi</span>
    
    <span class="c1"># some dummy variables:</span>
    <span class="n">start_hue</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dh</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hue_bin_edges</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nhbins</span> <span class="o">=</span> <span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ht_idx</span><span class="p">,</span> <span class="n">hr_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhbins</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nhbins</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span>
    
    <span class="c1"># calculate normalized hue-bin averages for jabt, jabr:</span>
    <span class="n">ht_hj</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">htype</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">hr_hj</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">htype</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">Ct_hj</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Cr_hj</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Ctn_hj</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="o">*</span><span class="n">Ct_hj</span><span class="o">/</span><span class="p">(</span><span class="n">Cr_hj</span> <span class="o">+</span> <span class="mf">1e-308</span><span class="p">)</span> <span class="c1"># calculate normalized chroma for samples under test</span>
    <span class="n">Ctn_hj</span><span class="p">[</span><span class="n">Cr_hj</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">jabtn_hj</span> <span class="o">=</span> <span class="n">jabt_hj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jabrn_hj</span> <span class="o">=</span> <span class="n">jabr_hj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jabtn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabtn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ctn_hj</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ht_hj</span><span class="p">),</span> <span class="n">Ctn_hj</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ht_hj</span><span class="p">)</span>
    <span class="n">jabrn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabrn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hr_hj</span><span class="p">),</span> <span class="n">normalized_chroma_ref</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hr_hj</span><span class="p">)</span>
    
    <span class="c1"># calculate normalized versions of jabt, jabr:</span>
    <span class="n">jabtn</span> <span class="o">=</span> <span class="n">jabt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jabrn</span> <span class="o">=</span> <span class="n">jabr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">Ctn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">Crn</span> <span class="o">=</span> <span class="n">Ctn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhbins</span><span class="p">):</span>
        <span class="n">Ctn</span> <span class="o">=</span> <span class="n">Ctn</span> <span class="o">+</span> <span class="p">(</span><span class="n">Ct</span><span class="o">/</span><span class="n">Cr_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hr_idx</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
        <span class="n">Crn</span> <span class="o">=</span> <span class="n">Crn</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cr</span><span class="o">/</span><span class="n">Cr_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hr_idx</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
    <span class="n">Ctn</span><span class="o">*=</span><span class="n">normalized_chroma_ref</span>
    <span class="n">Crn</span><span class="o">*=</span><span class="n">normalized_chroma_ref</span>

    <span class="n">jabtn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ctn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span>
    <span class="n">jabtn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ctn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span>
    <span class="n">jabrn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
    <span class="n">jabrn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>

    <span class="c1"># closed jabt_hj, jabr_hj for Rg:</span>
    <span class="n">jabt_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabt_hj</span><span class="p">,</span><span class="n">jabt_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">jabr_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabr_hj</span><span class="p">,</span><span class="n">jabr_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    
    <span class="c1"># closed jabtn_hj, jabrn_hj for plotting:</span>
    <span class="n">jabtn_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabtn_hj</span><span class="p">,</span><span class="n">jabtn_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">jabrn_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabrn_hj</span><span class="p">,</span><span class="n">jabrn_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;jabt&#39;</span> <span class="p">:</span> <span class="n">jabt</span><span class="p">,</span> <span class="s1">&#39;jabr&#39;</span> <span class="p">:</span> <span class="n">jabr</span><span class="p">,</span> 
            <span class="s1">&#39;jabtn&#39;</span> <span class="p">:</span> <span class="n">jabtn</span><span class="p">,</span> <span class="s1">&#39;jabrn&#39;</span> <span class="p">:</span> <span class="n">jabrn</span><span class="p">,</span>
            <span class="s1">&#39;DEi&#39;</span> <span class="p">:</span> <span class="n">DEi</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="s1">&#39;Ct&#39;</span> <span class="p">:</span> <span class="n">Ct</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">:</span> <span class="n">Cr</span><span class="p">,</span> <span class="s1">&#39;ht&#39;</span> <span class="p">:</span> <span class="n">ht</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span> <span class="p">:</span> <span class="n">hr</span><span class="p">,</span> 
            <span class="s1">&#39;ht_idx&#39;</span> <span class="p">:</span> <span class="n">ht_idx</span><span class="p">,</span> <span class="s1">&#39;hr_idx&#39;</span> <span class="p">:</span> <span class="n">hr_idx</span><span class="p">,</span>
            <span class="s1">&#39;jabt_hj&#39;</span> <span class="p">:</span> <span class="n">jabt_hj</span><span class="p">,</span> <span class="s1">&#39;jabr_hj&#39;</span> <span class="p">:</span> <span class="n">jabr_hj</span><span class="p">,</span> <span class="s1">&#39;DE_hj&#39;</span> <span class="p">:</span> <span class="n">DE_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;jabt_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabt_hj_closed</span><span class="p">,</span> <span class="s1">&#39;jabr_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabr_hj_closed</span><span class="p">,</span>
            <span class="s1">&#39;jabtn_hj&#39;</span> <span class="p">:</span> <span class="n">jabtn_hj</span><span class="p">,</span> <span class="s1">&#39;jabrn_hj&#39;</span> <span class="p">:</span> <span class="n">jabrn_hj</span><span class="p">,</span>
            <span class="s1">&#39;jabtn_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabtn_hj_closed</span><span class="p">,</span> <span class="s1">&#39;jabrn_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabrn_hj_closed</span><span class="p">,</span>
            <span class="s1">&#39;ht_hj&#39;</span> <span class="p">:</span> <span class="n">ht_hj</span><span class="p">,</span> <span class="s1">&#39;hr_hj&#39;</span> <span class="p">:</span> <span class="n">hr_hj</span><span class="p">,</span> 
            <span class="s1">&#39;Ct_hj&#39;</span><span class="p">:</span> <span class="n">Ct_hj</span><span class="p">,</span> <span class="s1">&#39;Cr_hj&#39;</span> <span class="p">:</span> <span class="n">Cr_hj</span><span class="p">,</span> <span class="s1">&#39;Ctn_hj&#39;</span><span class="p">:</span> <span class="n">Ctn_hj</span><span class="p">,</span>
            <span class="s1">&#39;nhbins&#39;</span> <span class="p">:</span> <span class="n">nhbins</span><span class="p">,</span> <span class="s1">&#39;start_hue&#39;</span> <span class="p">:</span> <span class="n">start_hue</span><span class="p">,</span> 
            <span class="s1">&#39;normalized_chroma_ref&#39;</span> <span class="p">:</span> <span class="n">normalized_chroma_ref</span><span class="p">,</span> 
            <span class="s1">&#39;dh&#39;</span> <span class="p">:</span> <span class="n">dh</span><span class="p">,</span> <span class="s1">&#39;hue_bin_edges&#39;</span> <span class="p">:</span> <span class="n">hue_bin_edges</span><span class="p">,</span> 
            <span class="s1">&#39;hbinnrs&#39;</span> <span class="p">:</span> <span class="n">hr_idx</span><span class="p">}</span>
    
<div class="viewcode-block" id="_get_hue_bin_data">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri._get_hue_bin_data">[docs]</a>
<span class="k">def</span> <span class="nf">_get_hue_bin_data</span><span class="p">(</span><span class="n">jabt</span><span class="p">,</span> <span class="n">jabr</span><span class="p">,</span> <span class="n">start_hue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nhbins</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
                      <span class="n">normalized_chroma_ref</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Slice gamut spanned by the sample jabt, jabr and calculate hue-bin data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :jabt: </span>
<span class="sd">            | ndarray with jab sample data under test illuminant</span>
<span class="sd">        :jabr: </span>
<span class="sd">            | ndarray with jab sample data under reference illuminant</span>
<span class="sd">        :start_hue:</span>
<span class="sd">            | 0.0 or float, optional</span>
<span class="sd">            | Hue angle to start bin slicing</span>
<span class="sd">        :nhbins:</span>
<span class="sd">            | None or int, optional</span>
<span class="sd">            |   - None: defaults to using the sample hues themselves as &#39;bins&#39;. </span>
<span class="sd">            |           In other words, the number of bins will be equal to the </span>
<span class="sd">            |           number of samples.</span>
<span class="sd">            |   - float: number of bins to slice the sample gamut in.</span>
<span class="sd">        :normalized_chroma_ref:</span>
<span class="sd">            | 100.0 or float, optional</span>
<span class="sd">            | Controls the size (chroma/radius) of the normalization circle/gamut.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :dict:</span>
<span class="sd">            | Dictionary with keys:</span>
<span class="sd">            | </span>
<span class="sd">            | - &#39;jabt&#39;, &#39;jabr&#39;: ndarrays with jab sample data under test &amp; ref. illuminants</span>
<span class="sd">            | - &#39;DEi&#39;: ndarray with sample jab color difference between test and ref.</span>
<span class="sd">            | - &#39;Ct&#39;, &#39;Cr&#39;: chroma for each sample under test and ref.</span>
<span class="sd">            | - &#39;ht&#39;, &#39;hr&#39;: hue angles (rad.) for each sample under test and ref.</span>
<span class="sd">            | - &#39;ht_idx&#39;, &#39;hr_idx&#39;: hue bin indices for each sample under test and ref.</span>
<span class="sd">            | - &#39;jabt_hj&#39;, &#39;jabr_hj&#39;: ndarrays with hue-bin averaged jab&#39;s under test &amp; ref. illuminants</span>
<span class="sd">            | - &#39;DE_hj&#39; : ndarray with average  sample DE in each hue bin</span>
<span class="sd">            | - &#39;jabt_hj_closed&#39;, &#39;jabr_hj_closed&#39;: ndarrays with hue-bin averaged jab&#39;s under test &amp; ref. illuminants (closed gamut: 1st == last)</span>
<span class="sd">            | - &#39;jabtn_hj&#39;, &#39;jabrn_hj&#39;: ndarrays with hue-bin averaged and normalized jab&#39;s under test &amp; ref. illuminants </span>
<span class="sd">            | - &#39;jabtn_hj_closed&#39;, &#39;jabrn_hj_closed&#39;: ndarrays with hue-bin and normalized averaged jab&#39;s under test &amp; ref. illuminants (closed gamut: 1st == last)</span>
<span class="sd">            | - &#39;ht_hj&#39;, &#39;hr_hj&#39;: hues (rad.) for each hue bin for test and ref.</span>
<span class="sd">            | - &#39;Ct_hj&#39;, &#39;Cr_hj&#39;: chroma for each hue bin for test and ref.</span>
<span class="sd">            | - &#39;Ctn_hj&#39; : normalized chroma for each hue bin for test (ref = normalized_chroma_ref)</span>
<span class="sd">            | - &#39;nhbins&#39;: number of hue bins</span>
<span class="sd">            | - &#39;start_hue&#39; : start hue for bin slicing</span>
<span class="sd">            | - &#39;normalized_chroma_ref&#39;: normalized chroma value for ref.</span>
<span class="sd">            | - &#39;dh&#39;: hue-angle arcs (°)</span>
<span class="sd">            | - &#39;hue_bin_edges&#39;: hue bin edge (rad)</span>
<span class="sd">            | - &#39;hbinnrs&#39;:  hue bin indices for each sample under ref. (= hr_idx)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">nhbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_hue_bin_data_individual_samples</span><span class="p">(</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">normalized_chroma_ref</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># calculate hue-bin width, edges:</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="mi">360</span><span class="o">/</span><span class="n">nhbins</span> 
        <span class="n">hue_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_hue</span><span class="p">,</span> <span class="mi">360</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dh</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
        
    <span class="c1"># get hues of jabt, jabr:</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">htype</span> <span class="o">=</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">hr</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">htype</span> <span class="o">=</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    
    <span class="c1"># Get chroma of jabt, jabr:</span>
    <span class="n">Ct</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabt</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Cr</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabr</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    
    
    <span class="c1"># Calculate DEi between jabt, jabr:</span>
    <span class="n">DEi</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt</span> <span class="o">-</span> <span class="n">jabr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="c1"># calculate hue-bin averages for jabt, jabr:</span>
    <span class="n">jabt_hj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nhbins</span><span class="p">,</span><span class="n">ht</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">jabr_hj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nhbins</span><span class="p">,</span><span class="n">hr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">DE_hj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nhbins</span><span class="p">,</span><span class="n">hr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ht_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">((</span><span class="n">ht</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">hr_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">((</span><span class="n">hr</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">hr_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhbins</span><span class="p">):</span>
        <span class="n">cndt_hj</span> <span class="o">=</span> <span class="p">(</span><span class="n">ht</span><span class="o">&gt;=</span><span class="n">hue_bin_edges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ht</span><span class="o">&lt;</span><span class="n">hue_bin_edges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cndr_hj</span> <span class="o">=</span> <span class="p">(</span><span class="n">hr</span><span class="o">&gt;=</span><span class="n">hue_bin_edges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hr</span><span class="o">&lt;</span><span class="n">hue_bin_edges</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">ht_idx</span><span class="p">[</span><span class="n">cndt_hj</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="c1"># store hue bin indices for all samples</span>
        <span class="n">hr_idx</span><span class="p">[</span><span class="n">cndr_hj</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
        <span class="c1">#wt = np.sum(cndt_hj,axis=0,keepdims=True).astype(float)</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">cndr_hj</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1">#wt[wt==0] = np.nan</span>
        <span class="n">wr</span><span class="p">[</span><span class="n">wr</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">jabt_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">jabt</span> <span class="o">*</span> <span class="n">cndr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">wr</span><span class="o">.</span><span class="n">T</span> <span class="c1"># must use ref. bins !!!</span>
        <span class="n">jabr_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">jabr</span> <span class="o">*</span> <span class="n">cndr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">wr</span><span class="o">.</span><span class="n">T</span>
        <span class="n">DE_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">DEi</span> <span class="o">*</span> <span class="n">cndr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])</span><span class="o">/</span><span class="n">wr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="c1"># local color difference is average of DEi per hue bin !!</span>
        <span class="n">DE_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">wr</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># signal empty hue bins with a NaN</span>
        
    <span class="c1"># calculate normalized hue-bin averages for jabt, jabr:</span>
    <span class="n">ht_hj</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">htype</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">hr_hj</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">hue_angle</span><span class="p">(</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">htype</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="n">Ct_hj</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Cr_hj</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Ctn_hj</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="o">*</span><span class="n">Ct_hj</span><span class="o">/</span><span class="p">(</span><span class="n">Cr_hj</span> <span class="o">+</span> <span class="mf">1e-308</span><span class="p">)</span> <span class="c1"># calculate normalized chroma for samples under test</span>
    <span class="n">Ctn_hj</span><span class="p">[</span><span class="n">Cr_hj</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">jabtn_hj</span> <span class="o">=</span> <span class="n">jabt_hj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jabrn_hj</span> <span class="o">=</span> <span class="n">jabr_hj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jabtn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabtn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ctn_hj</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ht_hj</span><span class="p">),</span> <span class="n">Ctn_hj</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ht_hj</span><span class="p">)</span>
    <span class="n">jabrn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">jabrn_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hr_hj</span><span class="p">),</span> <span class="n">normalized_chroma_ref</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hr_hj</span><span class="p">)</span>
    
    <span class="c1"># calculate normalized versions of jabt, jabr:</span>
    <span class="n">jabtn</span> <span class="o">=</span> <span class="n">jabt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">jabrn</span> <span class="o">=</span> <span class="n">jabr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">Ctn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">Crn</span> <span class="o">=</span> <span class="n">Ctn</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nhbins</span><span class="p">):</span>
        <span class="n">Ctn</span> <span class="o">=</span> <span class="n">Ctn</span> <span class="o">+</span> <span class="p">(</span><span class="n">Ct</span><span class="o">/</span><span class="n">Cr_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hr_idx</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
        <span class="n">Crn</span> <span class="o">=</span> <span class="n">Crn</span> <span class="o">+</span> <span class="p">(</span><span class="n">Cr</span><span class="o">/</span><span class="n">Cr_hj</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">hr_idx</span><span class="o">==</span><span class="n">j</span><span class="p">)</span>
    <span class="n">Ctn</span><span class="o">*=</span><span class="n">normalized_chroma_ref</span>
    <span class="n">Crn</span><span class="o">*=</span><span class="n">normalized_chroma_ref</span>
    <span class="n">jabtn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ctn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span>
    <span class="n">jabtn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ctn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span>
    <span class="n">jabrn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
    <span class="n">jabrn</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Crn</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
    <span class="c1"># import matplotlib.pyplot as plt # lazy import</span>
    <span class="c1"># plt.plot(jabtn[:,0,1],jabtn[:,0,2],&#39;b+&#39;)</span>
    <span class="c1"># plt.plot(jabrn[:,0,1],jabrn[:,0,2],&#39;rx&#39;)</span>
    <span class="c1"># plt.plot(jabtn_hj[:,0,1],jabtn_hj[:,0,2],&#39;bo-&#39;)</span>
    <span class="c1"># plt.plot(jabrn_hj[:,0,1],jabrn_hj[:,0,2],&#39;ro-&#39;)</span>
    <span class="c1"># plt.axis(&#39;equal&#39;)</span>

    <span class="c1"># closed jabt_hj, jabr_hj for Rg:</span>
    <span class="n">jabt_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabt_hj</span><span class="p">,</span><span class="n">jabt_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">jabr_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabr_hj</span><span class="p">,</span><span class="n">jabr_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    
    <span class="c1"># closed jabtn_hj, jabrn_hj for plotting:</span>
    <span class="n">jabtn_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabtn_hj</span><span class="p">,</span><span class="n">jabtn_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>
    <span class="n">jabrn_hj_closed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">jabrn_hj</span><span class="p">,</span><span class="n">jabrn_hj</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="o">...</span><span class="p">]))</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;jabt&#39;</span> <span class="p">:</span> <span class="n">jabt</span><span class="p">,</span> <span class="s1">&#39;jabr&#39;</span> <span class="p">:</span> <span class="n">jabr</span><span class="p">,</span> 
            <span class="s1">&#39;jabtn&#39;</span> <span class="p">:</span> <span class="n">jabtn</span><span class="p">,</span> <span class="s1">&#39;jabrn&#39;</span> <span class="p">:</span> <span class="n">jabrn</span><span class="p">,</span>
            <span class="s1">&#39;DEi&#39;</span> <span class="p">:</span> <span class="n">DEi</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
            <span class="s1">&#39;Ct&#39;</span> <span class="p">:</span> <span class="n">Ct</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">:</span> <span class="n">Cr</span><span class="p">,</span> <span class="s1">&#39;ht&#39;</span> <span class="p">:</span> <span class="n">ht</span><span class="p">,</span> <span class="s1">&#39;hr&#39;</span> <span class="p">:</span> <span class="n">hr</span><span class="p">,</span> 
            <span class="s1">&#39;ht_idx&#39;</span> <span class="p">:</span> <span class="n">ht_idx</span><span class="p">,</span> <span class="s1">&#39;hr_idx&#39;</span> <span class="p">:</span> <span class="n">hr_idx</span><span class="p">,</span>
            <span class="s1">&#39;jabt_hj&#39;</span> <span class="p">:</span> <span class="n">jabt_hj</span><span class="p">,</span> <span class="s1">&#39;jabr_hj&#39;</span> <span class="p">:</span> <span class="n">jabr_hj</span><span class="p">,</span> <span class="s1">&#39;DE_hj&#39;</span> <span class="p">:</span> <span class="n">DE_hj</span><span class="p">,</span>
            <span class="s1">&#39;jabt_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabt_hj_closed</span><span class="p">,</span> <span class="s1">&#39;jabr_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabr_hj_closed</span><span class="p">,</span>
            <span class="s1">&#39;jabtn_hj&#39;</span> <span class="p">:</span> <span class="n">jabtn_hj</span><span class="p">,</span> <span class="s1">&#39;jabrn_hj&#39;</span> <span class="p">:</span> <span class="n">jabrn_hj</span><span class="p">,</span>
            <span class="s1">&#39;jabtn_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabtn_hj_closed</span><span class="p">,</span> <span class="s1">&#39;jabrn_hj_closed&#39;</span> <span class="p">:</span> <span class="n">jabrn_hj_closed</span><span class="p">,</span>
            <span class="s1">&#39;ht_hj&#39;</span> <span class="p">:</span> <span class="n">ht_hj</span><span class="p">,</span> <span class="s1">&#39;hr_hj&#39;</span> <span class="p">:</span> <span class="n">hr_hj</span><span class="p">,</span> 
            <span class="s1">&#39;Ct_hj&#39;</span><span class="p">:</span> <span class="n">Ct_hj</span><span class="p">,</span> <span class="s1">&#39;Cr_hj&#39;</span> <span class="p">:</span> <span class="n">Cr_hj</span><span class="p">,</span> <span class="s1">&#39;Ctn_hj&#39;</span><span class="p">:</span> <span class="n">Ctn_hj</span><span class="p">,</span>
            <span class="s1">&#39;nhbins&#39;</span> <span class="p">:</span> <span class="n">nhbins</span><span class="p">,</span> <span class="s1">&#39;start_hue&#39;</span> <span class="p">:</span> <span class="n">start_hue</span><span class="p">,</span> 
            <span class="s1">&#39;normalized_chroma_ref&#39;</span> <span class="p">:</span> <span class="n">normalized_chroma_ref</span><span class="p">,</span> 
            <span class="s1">&#39;dh&#39;</span> <span class="p">:</span> <span class="n">dh</span><span class="p">,</span> <span class="s1">&#39;hue_bin_edges&#39;</span> <span class="p">:</span> <span class="n">hue_bin_edges</span><span class="p">,</span> 
            <span class="s1">&#39;hbinnrs&#39;</span> <span class="p">:</span> <span class="n">hr_idx</span><span class="p">}</span></div>


<span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_polyarea</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate area of polygon with coordinates (x,y).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>

<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_hue_bin_data_to_rg">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri._hue_bin_data_to_rg">[docs]</a>
<span class="k">def</span> <span class="nf">_hue_bin_data_to_rg</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">,</span> <span class="n">max_scale</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">normalize_gamut</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates gamut area index, Rg.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :hue_bin_data:</span>
<span class="sd">            | Dict with hue bin data obtained with _get_hue_bin_data().</span>
<span class="sd">        :max_scale:</span>
<span class="sd">            | 100.0, optional</span>
<span class="sd">            | Value of Rg when Rf = max_scale (i.e. DEavg = 0)</span>
<span class="sd">        :normalize_gamut:</span>
<span class="sd">            | False, optional</span>
<span class="sd">            | True normalizes the gamut of test to that of ref.</span>
<span class="sd">            | (perfect agreement results in circle).</span>
<span class="sd">        :out: </span>
<span class="sd">            | &#39;Rg&#39;, optional</span>
<span class="sd">            | Specifies which variables to output as ndarray</span>

<span class="sd">    Returns: </span>
<span class="sd">        :Rg: </span>
<span class="sd">            | float or ndarray with gamut area indices Rg.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="k">if</span> <span class="n">normalize_gamut</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">jabt_hj</span><span class="p">,</span> <span class="n">jabr_hj</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabt_hj_closed&#39;</span><span class="p">],</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabr_hj_closed&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jabt_hj</span><span class="p">,</span> <span class="n">jabr_hj</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabtn_hj_closed&#39;</span><span class="p">],</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabrn_hj_closed&#39;</span><span class="p">]</span>

    <span class="n">notnan_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">jabt_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># avoid NaN&#39;s (i.e. empty hue-bins)</span>
    <span class="n">notnan_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">jabr_hj</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="n">Rg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">max_scale</span><span class="o">*</span><span class="n">_polyarea</span><span class="p">(</span><span class="n">jabt_hj</span><span class="p">[</span><span class="n">notnan_t</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">jabt_hj</span><span class="p">[</span><span class="n">notnan_t</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">_polyarea</span><span class="p">(</span><span class="n">jabr_hj</span><span class="p">[</span><span class="n">notnan_r</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">jabr_hj</span><span class="p">[</span><span class="n">notnan_r</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">notnan_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]])</span>
    
    <span class="k">return</span> <span class="n">Rg</span></div>


<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_hue_bin_data_to_rxhj">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri._hue_bin_data_to_rxhj">[docs]</a>
<span class="k">def</span> <span class="nf">_hue_bin_data_to_rxhj</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span>
                             <span class="n">scale_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale_fcn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">use_bin_avg_DEi</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate hue bin measures: Rcshj, Rhshj, Rfhj, DEhj.</span>
<span class="sd">     </span>
<span class="sd">    |   Rcshj: local chroma shift</span>
<span class="sd">    |   Rhshj: local hue shift</span>
<span class="sd">    |   Rfhj: local (hue bin) color fidelity  </span>
<span class="sd">    |   DEhj: local (hue bin) color differences </span>
<span class="sd">    |</span>
<span class="sd">    |   (See IES TM30)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :hue_bin_data:</span>
<span class="sd">            | Dict with hue bin data obtained with _get_hue_bin_data().</span>
<span class="sd">        :use_bin_avg_DEi: </span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Note that following IES-TM30 DEhj from gamut_slicer() is obtained by</span>
<span class="sd">            | averaging the DEi per hue bin (True), and NOT by averaging the </span>
<span class="sd">            | jabt and jabr per hue  bin and then calculating the DEhj (False).</span>
<span class="sd">            | If None: use value in rg_pars dict in cri_type dict!</span>
<span class="sd">        :scale_fcn:</span>
<span class="sd">            | function handle to type of cri scale, </span>
<span class="sd">            | e.g. </span>
<span class="sd">            |   * linear()_scale --&gt; (100 - scale_factor*DEi), </span>
<span class="sd">            |   * log_scale --&gt; (cfr. Ohno&#39;s CQS), </span>
<span class="sd">            |   * psy_scale (Smet et al.&#39;s cri2012,See: LRT 2013)</span>
<span class="sd">        :scale_factor:</span>
<span class="sd">            | factors used in scaling function</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | ndarrays of Rcshj, Rhshj, Rfhj, DEhj </span>
<span class="sd">        </span>
<span class="sd">    References:</span>
<span class="sd">        1. `IES TM30, Method for Evaluating Light Source Color Rendition. </span>
<span class="sd">        New York, NY: The Illuminating Engineering Society of North America.</span>
<span class="sd">        &lt;https://www.ies.org/store/technical-memoranda/ies-method-for-evaluating-light-source-color-rendition/&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scale_fcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">use_bin_avg_DEi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
           <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>
           <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri._hue_bin_data_to_Ri&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get scale factor and function:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">scale_fcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">scale_fcn</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;fcn&#39;</span><span class="p">]</span>    
        
        <span class="k">if</span> <span class="p">(</span><span class="n">use_bin_avg_DEi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;rg_pars&#39;</span> <span class="ow">in</span> <span class="n">cri_type</span><span class="p">):</span> 
            <span class="n">use_bin_avg_DEi</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;rg_pars&#39;</span><span class="p">][</span><span class="s1">&#39;use_bin_avg_DEi&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Define use_bin_avg_DEi in rg_pars dict in cri_type dict or set use_bin_avg_DEi kwarg to not None!&#39;</span><span class="p">)</span>

    <span class="n">nhbins</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;nhbins&#39;</span><span class="p">]</span>
    <span class="n">start_hue</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;start_hue&#39;</span><span class="p">]</span>
    
    <span class="c1"># A. Local color fidelity, Rfhj:</span>
    <span class="k">if</span> <span class="n">use_bin_avg_DEi</span><span class="p">:</span>
        <span class="n">DEhj</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;DE_hj&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DEhj</span> <span class="o">=</span> <span class="p">((</span><span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabt_hj&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabr_hj&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">Rfhj</span> <span class="o">=</span> <span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEhj</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">)</span>
    
    <span class="c1"># B.Local chroma shift and hue shift, [Rcshi, Rhshi]:</span>
    <span class="c1"># B.1 relative paths:</span>
    <span class="n">dab</span> <span class="o">=</span> <span class="p">(</span><span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabt_hj&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabr_hj&#39;</span><span class="p">])[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;Cr_hj&#39;</span><span class="p">][</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-308</span><span class="p">)</span>

    <span class="c1"># B.2 Reference unit circle:</span>
    <span class="n">hbincenters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_hue</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">nhbins</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">nhbins</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">hbincenters</span><span class="p">)</span>
    <span class="n">brc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">hbincenters</span><span class="p">)</span>

    <span class="c1"># B.3 calculate local chroma shift, Rcshi:</span>
    <span class="n">Rcshj</span> <span class="o">=</span> <span class="n">dab</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arc</span> <span class="o">+</span> <span class="n">dab</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">brc</span>
    
    <span class="c1"># B.4 calculate local hue shift, Rcshi:</span>
    <span class="n">Rhshj</span> <span class="o">=</span> <span class="n">dab</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">arc</span> <span class="o">-</span> <span class="n">dab</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">brc</span>
    
    <span class="k">return</span> <span class="n">Rcshj</span><span class="p">,</span> <span class="n">Rhshj</span><span class="p">,</span> <span class="n">Rfhj</span><span class="p">,</span> <span class="n">DEhj</span> </div>


<span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_hue_bin_data_to_ellipsefit</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit ellipse to normalized color gamut,</span>
<span class="sd">    and calculate orientation angle (°) and eccentricity (ellipse a-axis / ellipse b-axis)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :hue_bin_data:</span>
<span class="sd">            | Dict with hue bin data obtained with _get_hue_bin_data().</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            | {&#39;v&#39;:v, &#39;a/b&#39;: ecc,&#39;thetad&#39;: theta}</span>
<span class="sd">            | v is an ndarray with [a,b, xc, yc, theta(rad)] describing the ellipse</span>
<span class="sd">            | &#39;a/b&#39; is the eccentricity</span>
<span class="sd">            | &#39;thetad&#39; is the angle in degrees, [0°,180°]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># use get chroma-normalized jabtn_hj:</span>
    <span class="n">jabt</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;jabtn_hj&#39;</span><span class="p">]</span>
    <span class="n">ecc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jabt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">fit_ellipse</span><span class="p">(</span><span class="n">jabt</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># major and minor ellipse axes</span>
            <span class="n">ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">b</span>
            <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span> <span class="c1"># orientation angle</span>
            <span class="k">if</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">180</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">ecc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># orientation angle</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;a/b&#39;</span><span class="p">:</span><span class="n">ecc</span><span class="p">,</span><span class="s1">&#39;thetad&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">}</span>


<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="_hue_bin_data_to_rfi">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri._hue_bin_data_to_rfi">[docs]</a>
<span class="k">def</span> <span class="nf">_hue_bin_data_to_rfi</span><span class="p">(</span><span class="n">hue_bin_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span>
                        <span class="n">scale_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale_fcn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get sample color differences DEi and calculate color fidelity values Rfi.</span>
<span class="sd">     </span>
<span class="sd">    |   Rfi: Sample color fidelity  </span>
<span class="sd">    |   DEi: Sample color differences </span>
<span class="sd">    |</span>
<span class="sd">    |   (See IES TM30)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :hue_bin_data:</span>
<span class="sd">            | Dict with hue bin data obtained with _get_hue_bin_data().</span>
<span class="sd">        :scale_fcn:</span>
<span class="sd">            | function handle to type of cri scale, </span>
<span class="sd">            | e.g. </span>
<span class="sd">            |   * linear()_scale --&gt; (100 - scale_factor*DEi), </span>
<span class="sd">            |   * log_scale --&gt; (cfr. Ohno&#39;s CQS), </span>
<span class="sd">            |   * psy_scale (Smet et al.&#39;s cri2012,See: LRT 2013)</span>
<span class="sd">        :scale_factor:</span>
<span class="sd">            | factors used in scaling function</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | ndarrays of Rfi, DEi </span>
<span class="sd">        </span>
<span class="sd">    References:</span>
<span class="sd">        1. `IES TM30, Method for Evaluating Light Source Color Rendition. </span>
<span class="sd">        New York, NY: The Illuminating Engineering Society of North America.</span>
<span class="sd">        &lt;https://www.ies.org/store/technical-memoranda/ies-method-for-evaluating-light-source-color-rendition/&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scale_fcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
           <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>
           <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri._hue_bin_data_to_Rfi&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get scale factor and function:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">scale_fcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">scale_fcn</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;fcn&#39;</span><span class="p">]</span>   
    
    <span class="c1"># Color fidelity, Rfi:</span>
    <span class="n">DEi</span> <span class="o">=</span> <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;DEi&#39;</span><span class="p">]</span>
    <span class="n">Rfi</span> <span class="o">=</span> <span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEi</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">Rfi</span><span class="p">,</span> <span class="n">DEi</span></div>


<span class="c1">#------------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_hue_bin_data_to_rf</span><span class="p">(</span><span class="n">hue_bin_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span>
                        <span class="n">scale_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scale_fcn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Rf,DEa&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get average sample color difference DEa and calculate color fidelity index Rf.</span>
<span class="sd">     </span>
<span class="sd">    |   Rf: color fidelity index</span>
<span class="sd">    |   DEa: average color difference </span>
<span class="sd">    |</span>
<span class="sd">    |   (See IES TM30)</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :hue_bin_data:</span>
<span class="sd">            | Dict with hue bin data obtained with _get_hue_bin_data().</span>
<span class="sd">        :scale_fcn:</span>
<span class="sd">            | function handle to type of cri scale, </span>
<span class="sd">            | e.g. </span>
<span class="sd">            |   * linear()_scale --&gt; (100 - scale_factor*DEi), </span>
<span class="sd">            |   * log_scale --&gt; (cfr. Ohno&#39;s CQS), </span>
<span class="sd">            |   * psy_scale (Smet et al.&#39;s cri2012,See: LRT 2013)</span>
<span class="sd">        :scale_factor:</span>
<span class="sd">            | factors used in scaling function</span>
<span class="sd">        :avg:</span>
<span class="sd">            | Averaging function for DEi -&gt; DEa.</span>
<span class="sd">        :out: </span>
<span class="sd">            | &#39;Rf,DEa&#39; or str, optional</span>
<span class="sd">            | Specifies requested output  </span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | ndarrays of Rf, DEa</span>
<span class="sd">        </span>
<span class="sd">    References:</span>
<span class="sd">        1. `IES TM30, Method for Evaluating Light Source Color Rendition. </span>
<span class="sd">        New York, NY: The Illuminating Engineering Society of North America.</span>
<span class="sd">        &lt;https://www.ies.org/store/technical-memoranda/ies-method-for-evaluating-light-source-color-rendition/&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">scale_fcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">avg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> 
           <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>
           <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri._hue_bin_data_to_Rfi&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get scale factor and function:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">scale_fcn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">scale_fcn</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;fcn&#39;</span><span class="p">]</span> 
            
        <span class="c1"># Get averaging function:</span>
            <span class="n">avg</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span> 
    
    <span class="c1"># Color fidelity, Rfi:</span>
    <span class="n">DEa</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;DEi&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">Rf</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEa</span><span class="p">,</span> <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">))</span>
  
    <span class="c1"># output:</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rf,DEa&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Rf</span><span class="p">,</span> <span class="n">DEa</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rf&#39;</span><span class="p">:</span>
        <span class="k">return</span>  <span class="n">Rf</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEa&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEa</span>

<div class="viewcode-block" id="spd_to_jab_t_r">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri.spd_to_jab_t_r">[docs]</a>
<span class="k">def</span> <span class="nf">spd_to_jab_t_r</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;jabt,jabr&#39;</span><span class="p">,</span> 
                   <span class="n">wl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sampleset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                   <span class="n">cieobs</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cspace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">catf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                   <span class="n">cri_specific_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates jab color values for a sample set illuminated with test source </span>
<span class="sd">    SPD and its reference illuminant.</span>
<span class="sd">        </span>
<span class="sd">    Args:</span>
<span class="sd">        :St: </span>
<span class="sd">            | ndarray with spectral data </span>
<span class="sd">            | (can be multiple SPDs, first axis are the wavelengths)</span>
<span class="sd">        :out: </span>
<span class="sd">            | &#39;jabt,jabr&#39; or str, optional</span>
<span class="sd">            | Specifies requested output (e.g.&#39;jabt,jabr&#39; or &#39;jabt,jabr,cct,duv&#39;) </span>
<span class="sd">        :wl: </span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Wavelengths (or [start, end, spacing]) to interpolate the spds in St to. </span>
<span class="sd">            | None: default to no interpolation</span>
<span class="sd">        :cri_type:</span>
<span class="sd">            | _CRI_TYPE_DEFAULT or str or dict, optional</span>
<span class="sd">            |   -&#39;str: specifies dict with default cri model parameters </span>
<span class="sd">            |     (for supported types, see luxpy.cri._CRI_DEFAULTS[&#39;cri_types&#39;])</span>
<span class="sd">            |   - dict: user defined model parameters </span>
<span class="sd">            |     (see e.g. luxpy.cri._CRI_DEFAULTS[&#39;cierf&#39;] </span>
<span class="sd">            |     for required structure)</span>
<span class="sd">            | Note that any non-None input arguments to the function will </span>
<span class="sd">            |  override default values in cri_type dict.</span>
<span class="sd">            </span>
<span class="sd">        :sampleset:</span>
<span class="sd">            | None or ndarray or str, optional</span>
<span class="sd">            | Specifies set of spectral reflectance samples for cri calculations.</span>
<span class="sd">            |     - None defaults to standard set for metric in cri_type.</span>
<span class="sd">            |     - ndarray: user defined set of spectral reflectance functions </span>
<span class="sd">            |       (.shape = (N+1, number of wavelengths); </span>
<span class="sd">            |        first axis are wavelengths)</span>
<span class="sd">        :ref_type:</span>
<span class="sd">            | None or str or ndarray, optional</span>
<span class="sd">            | Specifies type of reference illuminant type.</span>
<span class="sd">            |     - None: defaults to metric_specific reference illuminant in </span>
<span class="sd">            |             accordance with cri_type.</span>
<span class="sd">            |     - str: &#39;BB&#39; : Blackbody radiatiors, </span>
<span class="sd">            |            &#39;DL&#39;: daylightphase, </span>
<span class="sd">            |            &#39;ciera&#39;: used in CIE CRI-13.3-1995, </span>
<span class="sd">            |            &#39;cierf&#39;: used in CIE 224-2017, </span>
<span class="sd">            |            &#39;iesrf&#39;: used in TM30-15, ...</span>
<span class="sd">            |     - ndarray: user defined reference SPD</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which CMF sets to use for the calculation of the sample </span>
<span class="sd">            | XYZs and the CCT (for reference illuminant calculation).</span>
<span class="sd">            | None defaults to the one specified in :cri_type: dict.    </span>
<span class="sd">            |     - key: &#39;xyz&#39;: str specifying CMF set for calculating xyz </span>
<span class="sd">            |                   of samples and white </span>
<span class="sd">            |     - key: &#39;cct&#39;: str specifying CMF set for calculating cct</span>
<span class="sd">        :cspace:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which color space to use.</span>
<span class="sd">            | None defaults to the one specified in  :cri_type: dict.  </span>
<span class="sd">            |     - key: &#39;type&#39;: str specifying color space used to calculate </span>
<span class="sd">            |                    color differences in.</span>
<span class="sd">            |     - key: &#39;xyzw&#39;: None or ndarray with white point of color space</span>
<span class="sd">            |            If None: use xyzw of test / reference (after chromatic </span>
<span class="sd">            |                     adaptation, if specified)</span>
<span class="sd">            |     - other keys specify other possible parameters needed for color</span>
<span class="sd">            |       space calculation, </span>
<span class="sd">            |       see lx.cri._CRI_DEFAULTS[&#39;iesrf&#39;][&#39;cspace&#39;] for details. </span>
<span class="sd">        :catf:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Perform explicit CAT before converting to color space coordinates.</span>
<span class="sd">            |    - None: don&#39;t apply a cat (other than perhaps the one built </span>
<span class="sd">            |            into the colorspace) </span>
<span class="sd">            |    - dict: with CAT parameters:</span>
<span class="sd">            |        - key: &#39;D&#39;: ndarray with degree of adaptation</span>
<span class="sd">            |        - key: &#39;mcat&#39;: ndarray with sensor matrix specification</span>
<span class="sd">            |        - key: &#39;xyzw&#39;: None or ndarray with white point</span>
<span class="sd">            |              None: use xyzw of reference otherwise transform both </span>
<span class="sd">            |                    test and ref to xyzw</span>
<span class="sd">        :cri_specific_pars:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies other parameters specific to type of cri </span>
<span class="sd">            | (e.g. maxC for CQS calculations)</span>
<span class="sd">            |     - None: default to the one specified in  :cri_type: dict. </span>
<span class="sd">            |     - dict: user specified parameters. </span>
<span class="sd">            |         For its use, see for example:</span>
<span class="sd">            |             luxpy.cri._CRI_DEFAULTS[&#39;mcri&#39;][&#39;cri_specific_pars&#39;]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | (ndarray, ndarray) </span>
<span class="sd">            | with jabt and jabr data for :out: &#39;jabt,jabr&#39;</span>
<span class="sd">            | </span>
<span class="sd">            | Other output is also possible by changing the :out: str value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
   
    <span class="c1">#Override input parameters with data specified in cri_type:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>
    <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri.spd_to_jab_t_r&#39;</span><span class="p">)</span>
    
    <span class="c1"># unpack and update dict with parameters:</span>
    <span class="p">(</span><span class="n">avg</span><span class="p">,</span> <span class="n">catf</span><span class="p">,</span> <span class="n">cieobs</span><span class="p">,</span>
     <span class="n">cri_specific_pars</span><span class="p">,</span> <span class="n">cspace</span><span class="p">,</span> 
     <span class="n">ref_type</span><span class="p">,</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">,</span> <span class="n">rg_pars</span><span class="p">,</span> <span class="n">sampleset</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="o">=</span> <span class="p">[</span><span class="n">cri_type</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cri_type</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span> 

    <span class="c1"># pre-interpolate SPD:</span>
    <span class="k">if</span> <span class="n">wl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">St</span> <span class="o">=</span> <span class="n">cie_interp</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">wl_new</span> <span class="o">=</span> <span class="n">wl</span><span class="p">,</span> <span class="n">kind</span> <span class="o">=</span> <span class="n">_S_INTERP_TYPE</span><span class="p">)</span>
      
    <span class="c1"># obtain sampleset:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampleset</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">sampleset</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">sampleset</span><span class="p">)</span>
    
    <span class="c1"># A. calculate reference illuminant:</span>
    <span class="c1"># A.a. get xyzw:</span>
    <span class="n">xyztw_cct</span> <span class="o">=</span> <span class="n">spd_to_xyz</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">[</span><span class="s1">&#39;cct&#39;</span><span class="p">],</span> <span class="n">rfl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># A.b. get cct:</span>
    <span class="n">cct</span><span class="p">,</span> <span class="n">duv</span> <span class="o">=</span> <span class="n">xyz_to_cct</span><span class="p">(</span><span class="n">xyztw_cct</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">[</span><span class="s1">&#39;cct&#39;</span><span class="p">],</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;cct,duv&#39;</span><span class="p">,</span><span class="n">mode</span> <span class="o">=</span> <span class="n">_CCT_MODE</span><span class="p">)</span>
    <span class="n">cct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cct</span><span class="p">)</span> <span class="c1"># out-of-lut ccts are encoded as negative</span>
    
    <span class="c1"># A.c. get reference ill.:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_type</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">Sr</span> <span class="o">=</span> <span class="n">cri_ref</span><span class="p">(</span><span class="n">ref_type</span><span class="p">,</span> <span class="n">ref_type</span> <span class="o">=</span> <span class="s1">&#39;spd&#39;</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">[</span><span class="s1">&#39;cct&#39;</span><span class="p">],</span> <span class="n">wl3</span> <span class="o">=</span> <span class="n">St</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Sr</span> <span class="o">=</span> <span class="n">cri_ref</span><span class="p">(</span><span class="n">cct</span><span class="p">,</span> <span class="n">ref_type</span> <span class="o">=</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">[</span><span class="s1">&#39;cct&#39;</span><span class="p">],</span> <span class="n">wl3</span> <span class="o">=</span> <span class="n">St</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># B. calculate xyz and xyzw of SPD and Sr (stack for speed):</span>
    <span class="n">xyzi</span><span class="p">,</span> <span class="n">xyzw</span> <span class="o">=</span> <span class="n">spd_to_xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="n">cieobs</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="n">rfl</span> <span class="o">=</span> <span class="n">sampleset</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1">#xyzri, xyzrw = spd_to_xyz(Sr, cieobs = cieobs[&#39;xyz&#39;], rfl = sampleset, out = 2)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">St</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">xyzti</span><span class="p">,</span> <span class="n">xyzri</span> <span class="o">=</span>  <span class="n">xyzi</span><span class="p">[:,:</span><span class="n">N</span><span class="p">,:],</span> <span class="n">xyzi</span><span class="p">[:,</span><span class="n">N</span><span class="p">:,:]</span>
    <span class="n">xyztw</span><span class="p">,</span> <span class="n">xyzrw</span> <span class="o">=</span>  <span class="n">xyzw</span><span class="p">[:</span><span class="n">N</span><span class="p">,:],</span> <span class="n">xyzw</span><span class="p">[</span><span class="n">N</span><span class="p">:,:]</span>
    
    <span class="c1"># C. apply chromatic adaptation for non-cam/lab cspaces:</span>
    <span class="k">if</span> <span class="n">catf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">D_cat</span><span class="p">,</span> <span class="n">Dtype_cat</span><span class="p">,</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">mcat_cat</span><span class="p">,</span> <span class="n">xyzw_cat</span> <span class="o">=</span> <span class="p">[</span><span class="n">catf</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">catf</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        
        <span class="c1">#if not isinstance(D_cat,list): D_cat = [D_cat]</span>
        <span class="k">if</span> <span class="n">xyzw_cat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#transform from xyzwt --&gt; xyzwr</span>
            <span class="n">xyzti</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyzti</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyztw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
            <span class="n">xyztw</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyztw</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyztw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
            <span class="n">xyzri</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyzri</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
            <span class="n">xyzrw</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyzrw</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span> <span class="c1"># transform both xyzwr and xyzwt to xyzw_cat</span>
            <span class="n">xyzti</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyzti</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyztw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzw_cat</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
            <span class="n">xyztw</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyztw</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyztw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzw_cat</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
            <span class="n">xyzri</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyzri</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzw_cat</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>
            <span class="n">xyzrw</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">xyzrw</span><span class="p">,</span> <span class="n">cattype</span> <span class="o">=</span> <span class="n">cattype_cat</span><span class="p">,</span> <span class="n">catmode</span> <span class="o">=</span> <span class="n">catmode_cat</span><span class="p">,</span> <span class="n">xyzw1</span> <span class="o">=</span> <span class="n">xyzrw</span><span class="p">,</span> <span class="n">xyzw0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyzw2</span> <span class="o">=</span> <span class="n">xyzw_cat</span><span class="p">,</span> <span class="n">D</span> <span class="o">=</span> <span class="n">D_cat</span><span class="p">,</span> <span class="n">La</span> <span class="o">=</span> <span class="n">La_cat</span><span class="p">,</span> <span class="n">mcat</span> <span class="o">=</span> <span class="p">[</span><span class="n">mcat_cat</span><span class="p">],</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="n">Dtype_cat</span><span class="p">)</span>

    <span class="c1"># D. convert xyz to colorspace, cam or chromaticity co. lab (i.e. lab, ipt, Yuv, jab, wuv,..):</span>
    <span class="c1"># D.a. broadcast xyzw to shape of xyzi:</span>
    <span class="c1"># xyztw = xyztw[None] </span>
    <span class="c1"># xyzrw = xyzrw[None] </span>

    <span class="n">cspace_pars</span> <span class="o">=</span> <span class="n">cspace</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cspace_pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;xyzw&#39;</span> <span class="ow">in</span> <span class="n">cspace_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
        <span class="k">if</span> <span class="n">cspace_pars</span><span class="p">[</span><span class="s1">&#39;xyzw&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">cspace_pars</span><span class="p">[</span><span class="s1">&#39;xyzw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyztw</span> <span class="c1"># enter test whitepoint</span>
    <span class="n">jabt</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">xyzti</span><span class="p">,</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">cspace</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">fwtf</span> <span class="o">=</span> <span class="n">cspace_pars</span><span class="p">)</span>
    
    <span class="n">cspace_pars</span> <span class="o">=</span> <span class="n">cspace</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cspace_pars</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;xyzw&#39;</span> <span class="ow">in</span> <span class="n">cspace_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
        <span class="k">if</span> <span class="n">cspace_pars</span><span class="p">[</span><span class="s1">&#39;xyzw&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">cspace_pars</span><span class="p">[</span><span class="s1">&#39;xyzw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyzrw</span> <span class="c1"># enter ref. whitepoint</span>
    <span class="n">jabr</span> <span class="o">=</span> <span class="n">colortf</span><span class="p">(</span><span class="n">xyzri</span><span class="p">,</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">cspace</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">fwtf</span> <span class="o">=</span> <span class="n">cspace_pars</span><span class="p">)</span>    
    <span class="k">del</span> <span class="n">cspace_pars</span>


    <span class="c1"># E. Regulate output:</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;jabt,jabr,xyzti,xyztw,xyzri,xyzrw,xyztw_cct,cct,duv,St,Sr&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">xyzti</span><span class="p">,</span><span class="n">xyztw</span><span class="p">,</span><span class="n">xyzri</span><span class="p">,</span><span class="n">xyzrw</span><span class="p">,</span><span class="n">xyztw_cct</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;jabt,jabr,cct,duv,Sr&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">Sr</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;jabt,jabr,cct,duv&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;jabt,jabr&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jabt</span><span class="p">,</span> <span class="n">jabr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>



<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="spd_to_DEi">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri.spd_to_DEi">[docs]</a>
<span class="k">def</span> <span class="nf">spd_to_DEi</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;DEi&#39;</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
               <span class="n">sampleset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
               <span class="n">cspace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">catf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cri_specific_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates color differences (~fidelity), DEi, of spectral data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :St: </span>
<span class="sd">            | ndarray with spectral data </span>
<span class="sd">            | (can be multiple SPDs, first axis are the wavelengths)</span>
<span class="sd">        :out: </span>
<span class="sd">            | &#39;DEi&#39; or str, optional</span>
<span class="sd">            | Specifies requested output (e.g. &#39;DEi,DEa,cct,duv&#39;) </span>
<span class="sd">        :wl: </span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Wavelengths (or [start, end, spacing]) to interpolate the spds in St to. </span>
<span class="sd">            | None: default to no interpolation</span>
<span class="sd">        :cri_type:</span>
<span class="sd">            | _CRI_TYPE_DEFAULT or str or dict, optional</span>
<span class="sd">            |   -&#39;str: specifies dict with default cri model parameters </span>
<span class="sd">            |     (for supported types, see luxpy.cri._CRI_DEFAULTS[&#39;cri_types&#39;])</span>
<span class="sd">            |   - dict: user defined model parameters </span>
<span class="sd">            |     (see e.g. luxpy.cri._CRI_DEFAULTS[&#39;cierf&#39;] </span>
<span class="sd">            |     for required structure)</span>
<span class="sd">            | Note that any non-None input arguments to the function will </span>
<span class="sd">              override default values in cri_type dict.</span>
<span class="sd">        :sampleset:</span>
<span class="sd">            | None or ndarray or str, optional</span>
<span class="sd">            | Specifies set of spectral reflectance samples for cri calculations.</span>
<span class="sd">            |     - None defaults to standard set for metric in cri_type.</span>
<span class="sd">            |     - ndarray: user defined set of spectral reflectance functions </span>
<span class="sd">            |       (.shape = (N+1, number of wavelengths); </span>
<span class="sd">            |        first axis are wavelengths)</span>
<span class="sd">        :ref_type:</span>
<span class="sd">            | None or str or ndarray, optional</span>
<span class="sd">            | Specifies type of reference illuminant type.</span>
<span class="sd">            |     - None: defaults to metric_specific reference illuminant in </span>
<span class="sd">            |             accordance with cri_type.</span>
<span class="sd">            |     - str: &#39;BB&#39; : Blackbody radiatiors, </span>
<span class="sd">            |            &#39;DL&#39;: daylightphase, </span>
<span class="sd">            |            &#39;ciera&#39;: used in CIE CRI-13.3-1995, </span>
<span class="sd">            |            &#39;cierf&#39;: used in CIE 224-2017, </span>
<span class="sd">            |            &#39;iesrf&#39;: used in TM30-15, ...</span>
<span class="sd">            |     - ndarray: user defined reference SPD</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which CMF sets to use for the calculation of the sample </span>
<span class="sd">            | XYZs and the CCT (for reference illuminant calculation).</span>
<span class="sd">            | None defaults to the one specified in :cri_type: dict.    </span>
<span class="sd">            |     - key: &#39;xyz&#39;: str specifying CMF set for calculating xyz </span>
<span class="sd">            |                   of samples and white </span>
<span class="sd">            |     - key: &#39;cct&#39;: str specifying CMF set for calculating cct</span>
<span class="sd">        :cspace:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which color space to use.</span>
<span class="sd">            | None defaults to the one specified in  :cri_type: dict.  </span>
<span class="sd">            |     - key: &#39;type&#39;: str specifying color space used to calculate </span>
<span class="sd">            |                    color differences in.</span>
<span class="sd">            |     - key: &#39;xyzw&#39;: None or ndarray with white point of color space</span>
<span class="sd">            |            If None: use xyzw of test / reference (after chromatic </span>
<span class="sd">            |                     adaptation, if specified)</span>
<span class="sd">            |     - other keys specify other possible parameters needed for color</span>
<span class="sd">            |       space calculation, </span>
<span class="sd">            |       see lx.cri._CRI_DEFAULTS[&#39;iesrf&#39;][&#39;cspace&#39;] for details. </span>
<span class="sd">        :catf:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Perform explicit CAT before converting to color space coordinates.</span>
<span class="sd">            |    - None: don&#39;t apply a cat (other than perhaps the one built </span>
<span class="sd">            |            into the colorspace) </span>
<span class="sd">            |    - dict: with CAT parameters:</span>
<span class="sd">            |        - key: &#39;D&#39;: ndarray with degree of adaptation</span>
<span class="sd">            |        - key: &#39;mcat&#39;: ndarray with sensor matrix specification</span>
<span class="sd">            |        - key: &#39;xyzw&#39;: None or ndarray with white point</span>
<span class="sd">            |              None: use xyzw of reference otherwise transform both </span>
<span class="sd">            |                    test and ref to xyzw</span>
<span class="sd">        :cri_specific_pars:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies other parameters specific to type of cri </span>
<span class="sd">            | (e.g. maxC for CQS calculations)</span>
<span class="sd">            |     - None: default to the one specified in  :cri_type: dict. </span>
<span class="sd">            |     - dict: user specified parameters. </span>
<span class="sd">            |         For its use, see for example:</span>
<span class="sd">            |             luxpy.cri._CRI_DEFAULTS[&#39;mcri&#39;][&#39;cri_specific_pars&#39;]</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | float or ndarray with DEi for :out: &#39;DEi&#39;</span>
<span class="sd">            | </span>
<span class="sd">            | Other output is also possible by changing the :out: str value.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Override input parameters with data specified in cri_type:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>
    
    <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri.spd_to_DEi&#39;</span><span class="p">)</span>

    <span class="c1"># calculate Jabt of test and Jabr of the reference illuminant corresponding to test: </span>
    <span class="p">(</span><span class="n">jabt</span><span class="p">,</span> <span class="n">jabr</span><span class="p">,</span> 
     <span class="n">xyzti</span><span class="p">,</span> <span class="n">xyztw</span><span class="p">,</span> 
     <span class="n">xyzri</span><span class="p">,</span> <span class="n">xyzrw</span><span class="p">,</span>
     <span class="n">xyztw_cct</span><span class="p">,</span>
     <span class="n">cct</span><span class="p">,</span> <span class="n">duv</span><span class="p">,</span> <span class="n">St</span><span class="p">,</span> <span class="n">Sr</span><span class="p">)</span> <span class="o">=</span> <span class="n">spd_to_jab_t_r</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">,</span> 
                                        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;jabt,jabr,xyzti,xyztw,xyzri,xyzrw,xyztw_cct,cct,duv,St,Sr&#39;</span><span class="p">)</span>
      
    <span class="c1"># E. calculate DEi, DEa:</span>
    <span class="n">DEi</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt</span> <span class="o">-</span> <span class="n">jabr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">DEa</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">(</span><span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">](</span><span class="n">DEi</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
  
     <span class="c1"># output:</span>
    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEi,DEa,jabt,jabr,xyzti,xyztw,xyzri,xyzrw,xyztw_cct,cct,duv,St,Sr&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEi</span><span class="p">,</span><span class="n">DEa</span><span class="p">,</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">xyzti</span><span class="p">,</span><span class="n">xyztw</span><span class="p">,</span><span class="n">xyzri</span><span class="p">,</span><span class="n">xyzrw</span><span class="p">,</span><span class="n">xyztw_cct</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEa&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEa</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEi&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEi</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEi,DEa&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEi</span><span class="p">,</span><span class="n">DEa</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEa,DEi&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEa</span><span class="p">,</span><span class="n">DEi</span>
    <span class="k">elif</span> <span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;DEi,DEa,jabt,jabr,cct,duv,Sr&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">DEi</span><span class="p">,</span><span class="n">DEa</span><span class="p">,</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">Sr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>  <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>



<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="optimize_scale_factor">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri.optimize_scale_factor">[docs]</a>
<span class="k">def</span> <span class="nf">optimize_scale_factor</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">opt_scale_factor</span><span class="p">,</span> <span class="n">scale_fcn</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">)</span> <span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize scale_factor of cri-model in cri_type </span>
<span class="sd">    such that average Rf for a set of light sources is the same as that </span>
<span class="sd">    of a target-cri (default: &#39;ciera&#39;).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :cri_type: </span>
<span class="sd">            | str or dict</span>
<span class="sd">            |   -&#39;str: specifies dict with default cri model parameters </span>
<span class="sd">            |       (for supported types, see luxpy.cri._CRI_DEFAULTS[&#39;cri_types&#39;])</span>
<span class="sd">            |   - dict: user defined model parameters </span>
<span class="sd">            |       (see e.g. luxpy.cri._CRI_DEFAULTS[&#39;cierf&#39;] </span>
<span class="sd">            |       for required structure)</span>
<span class="sd">        :opt_scale:</span>
<span class="sd">            | True or False</span>
<span class="sd">            | True: optimize scaling-factor, else do nothing and use value of </span>
<span class="sd">            | scaling-factor in :scale: dict.   </span>
<span class="sd">        :scale_fcn:</span>
<span class="sd">            | function handle to type of cri scale, </span>
<span class="sd">            | e.g. </span>
<span class="sd">            |   * linear()_scale --&gt; (100 - scale_factor*DEi), </span>
<span class="sd">            |   * log_scale --&gt; (cfr. Ohno&#39;s CQS), </span>
<span class="sd">            |   * psy_scale (Smet et al.&#39;s cri2012,See: LRT 2013)</span>
<span class="sd">        :avg: </span>
<span class="sd">            | None or fcn handle</span>
<span class="sd">            | Averaging function (handle) for color differences, DEi </span>
<span class="sd">            | (e.g. numpy.mean, .math.rms, .math.geomean)</span>
<span class="sd">            | None use the one specified in :cri_type: dict.</span>

<span class="sd">    Returns:</span>
<span class="sd">        :scaling_factor: </span>
<span class="sd">            | ndarray</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="s1">&#39;opt_cri_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
            <span class="n">opt_cri_type</span> <span class="o">=</span> <span class="n">_CRI_DEFAULTS</span><span class="p">[</span><span class="s1">&#39;ciera&#39;</span><span class="p">]</span> <span class="c1"># use CIE Ra-13.3-1995 as target</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;opt_cri_type&#39;</span><span class="p">],</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">opt_cri_type</span> <span class="o">=</span> <span class="n">_CRI_DEFAULTS</span><span class="p">[</span><span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;opt_cri_type&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#should be dict !!</span>
                <span class="n">opt_cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;opt_cri_type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;opt_spd_set&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
            <span class="n">opt_spd_set</span> <span class="o">=</span> <span class="n">_IESTM3015</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span> <span class="c1"># use CIE F1-F12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">opt_spd_set</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;opt_spd_set&#39;</span><span class="p">]</span>
        
        <span class="n">scale_fcn_opt</span> <span class="o">=</span> <span class="n">opt_cri_type</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;fcn&#39;</span><span class="p">]</span>
        <span class="n">scale_factor_opt</span> <span class="o">=</span> <span class="n">opt_cri_type</span> <span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span>
        <span class="n">avg_opt</span> <span class="o">=</span> <span class="n">opt_cri_type</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span>
        
        <span class="n">rf_from_avg_rounded_rfi_opt</span> <span class="o">=</span> <span class="n">opt_cri_type</span><span class="p">[</span><span class="s1">&#39;rf_from_avg_rounded_rfi&#39;</span><span class="p">]</span>
        <span class="n">rf_from_avg_rounded_rfi</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;rf_from_avg_rounded_rfi&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rf_from_avg_rounded_rfi_opt</span><span class="p">:</span>
            <span class="n">DEa_opt</span> <span class="o">=</span> <span class="n">spd_to_DEi</span><span class="p">(</span><span class="n">opt_spd_set</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span><span class="s1">&#39;DEa&#39;</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">opt_cri_type</span><span class="p">)</span> <span class="c1"># DEa using target cri</span>
            <span class="n">Rf_opt</span> <span class="o">=</span> <span class="n">avg</span><span class="p">(</span><span class="n">scale_fcn_opt</span><span class="p">(</span><span class="n">DEa_opt</span><span class="p">,</span><span class="n">scale_factor_opt</span><span class="p">))</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DEi_opt</span> <span class="o">=</span> <span class="n">spd_to_DEi</span><span class="p">(</span><span class="n">opt_spd_set</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span><span class="s1">&#39;DEi&#39;</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">opt_cri_type</span><span class="p">)</span> <span class="c1"># DEa using target cri</span>
            <span class="n">Rfi_opt</span> <span class="o">=</span> <span class="n">avg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scale_fcn_opt</span><span class="p">(</span><span class="n">DEi_opt</span><span class="p">,</span><span class="n">scale_factor_opt</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># average rounded individual Rfi to get Rf !!!</span>
            <span class="n">Rf_opt</span> <span class="o">=</span> <span class="n">avg</span><span class="p">(</span><span class="n">Rfi_opt</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">:</span>
            <span class="n">DEa</span> <span class="o">=</span> <span class="n">spd_to_DEi</span><span class="p">(</span><span class="n">opt_spd_set</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span><span class="s1">&#39;DEa&#39;</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">)</span> <span class="c1"># DEa using current cri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DEi</span> <span class="o">=</span> <span class="n">spd_to_DEi</span><span class="p">(</span><span class="n">opt_spd_set</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span><span class="s1">&#39;DEi&#39;</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">)</span> <span class="c1"># DEa using target cri</span>
                        
            
        <span class="c1"># optimize scale_factor to minimize rms difference:</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span> <span class="c1"># get scale_factor of cri_type to determine len and non-optimized factors</span>
        
        <span class="k">if</span> <span class="n">sf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">sf</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span> <span class="c1">#(isinstance(1.0*sf,float))</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="p">[</span><span class="n">sf</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">opt_scale_factor</span> <span class="o">=</span> <span class="p">[</span><span class="n">opt_scale_factor</span><span class="p">]</span> 
            
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">:</span>
                <span class="n">optfcn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEa</span><span class="p">,</span><span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="n">Rf_opt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># optimize the only cfactor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optfcn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEi</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="n">Rf_opt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>     
            <span class="n">x0</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">:</span> 
                <span class="n">optfcn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEa</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sf</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)))</span> <span class="o">-</span> <span class="n">Rf_opt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># optimize the first cfactor (for scale_factor input of len = 1)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optfcn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sf</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)),</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="n">Rf_opt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># optimize the first cfactor (for scale_factor input of len = 1)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">:</span> 
                <span class="n">optfcn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEa</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)])</span> <span class="p">)))</span> <span class="o">-</span> <span class="n">Rf_opt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># optimize first N &#39;True&#39; cfactor (for scale_factor input of len = n&gt;=N)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">optfcn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">rms</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEa</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)])</span> <span class="p">)),</span><span class="mi">0</span><span class="p">)))</span> <span class="o">-</span> <span class="n">Rf_opt</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># optimize first N &#39;True&#39; cfactor (for scale_factor input of len = n&gt;=N)</span>
        
        <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span> <span class="c1"># lazy import</span>
        <span class="n">optresult</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">fun</span> <span class="o">=</span> <span class="n">optfcn</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">)</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">optresult</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>

        <span class="c1">#Reconstruct &#39;scale_factor&#39; from optimized and fixed parts:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">pass</span> <span class="c1">#only cfactor</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>     
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span><span class="n">sf</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span><span class="n">sf</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">opt_scale_factor</span><span class="p">)])</span> <span class="p">)</span> <span class="c1"># optimize first N &#39;True&#39; cfactor (for scale_factor input of len = n&gt;=N)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">scale_factor</span></div>


<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="spd_to_rg">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri.spd_to_rg">[docs]</a>
<span class="k">def</span> <span class="nf">spd_to_rg</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Rg&#39;</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
              <span class="n">sampleset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cieobs</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
              <span class="n">cspace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">catf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cri_specific_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rg_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">fit_gamut_ellipse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the color gamut index, Rg, of spectral data. </span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :St: </span>
<span class="sd">            | ndarray with spectral data </span>
<span class="sd">            | (can be multiple SPDs, first axis are the wavelengths)</span>
<span class="sd">        :out: </span>
<span class="sd">            | &#39;Rg&#39; or str, optional</span>
<span class="sd">            | Specifies requested output (e.g. &#39;Rg,cct,duv&#39;) </span>
<span class="sd">        :wl: </span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Wavelengths (or [start, end, spacing]) to interpolate the SPDs to. </span>
<span class="sd">            | None: default to no interpolation</span>
<span class="sd">        :cri_type:</span>
<span class="sd">            | _CRI_TYPE_DEFAULT or str or dict, optional</span>
<span class="sd">            |   -&#39;str: specifies dict with default cri model parameters </span>
<span class="sd">            |     (for supported types, see luxpy.cri._CRI_DEFAULTS[&#39;cri_types&#39;])</span>
<span class="sd">            |   - dict: user defined model parameters </span>
<span class="sd">            |     (see e.g. luxpy.cri._CRI_DEFAULTS[&#39;cierf&#39;] </span>
<span class="sd">            |     for required structure)</span>
<span class="sd">            | Note that any non-None input arguments to the function will </span>
<span class="sd">            | override default values in cri_type dict.</span>
<span class="sd">        :sampleset:</span>
<span class="sd">            | None or ndarray or str, optional</span>
<span class="sd">            | Specifies set of spectral reflectance samples for cri calculations.</span>
<span class="sd">            |     - None defaults to standard set for metric in cri_type.</span>
<span class="sd">            |     - ndarray: user defined set of spectral reflectance functions </span>
<span class="sd">            |       (.shape = (N+1, number of wavelengths); </span>
<span class="sd">            |        first axis are wavelengths)</span>
<span class="sd">        :ref_type:</span>
<span class="sd">            | None or str or ndarray, optional</span>
<span class="sd">            | Specifies type of reference illuminant type.</span>
<span class="sd">            |     - None: defaults to metric_specific reference illuminant in </span>
<span class="sd">            |             accordance with cri_type.</span>
<span class="sd">            |     - str: &#39;BB&#39; : Blackbody radiatiors, </span>
<span class="sd">            |            &#39;DL&#39;: daylightphase, </span>
<span class="sd">            |            &#39;ciera&#39;: used in CIE CRI-13.3-1995, </span>
<span class="sd">            |            &#39;cierf&#39;: used in CIE 224-2017, </span>
<span class="sd">            |            &#39;iesrf&#39;: used in TM30-15, ...</span>
<span class="sd">            |     - ndarray: user defined reference SPD</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which CMF sets to use for the calculation of the sample </span>
<span class="sd">            | XYZs and the CCT (for reference illuminant calculation).</span>
<span class="sd">            | None defaults to the one specified in :cri_type: dict.    </span>
<span class="sd">            |     - key: &#39;xyz&#39;: str specifying CMF set for calculating xyz </span>
<span class="sd">            |                   of samples and white </span>
<span class="sd">            |     - key: &#39;cct&#39;: str specifying CMF set for calculating cct</span>
<span class="sd">        :cspace:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which color space to use.</span>
<span class="sd">            | None defaults to the one specified in  :cri_type: dict.  </span>
<span class="sd">            |     - key: &#39;type&#39;: str specifying color space used to calculate </span>
<span class="sd">            |                    color differences in.</span>
<span class="sd">            |     - key: &#39;xyzw&#39;: None or ndarray with white point of color space</span>
<span class="sd">            |            If None: use xyzw of test / reference (after chromatic </span>
<span class="sd">            |                     adaptation, if specified)</span>
<span class="sd">            |     - other keys specify other possible parameters needed for color</span>
<span class="sd">            |       space calculation, </span>
<span class="sd">            |       see lx.cri._CRI_DEFAULTS[&#39;iesrf&#39;][&#39;cspace&#39;] for details. </span>
<span class="sd">        :catf:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Perform explicit CAT before converting to color space coordinates.</span>
<span class="sd">            |    - None: don&#39;t apply a cat (other than perhaps the one built </span>
<span class="sd">            |            into the colorspace) </span>
<span class="sd">            |    - dict: with CAT parameters:</span>
<span class="sd">            |        - key: &#39;D&#39;: ndarray with degree of adaptation</span>
<span class="sd">            |        - key: &#39;mcat&#39;: ndarray with sensor matrix specification</span>
<span class="sd">            |        - key: &#39;xyzw&#39;: None or ndarray with white point</span>
<span class="sd">            |              None: use xyzw of reference otherwise transform both </span>
<span class="sd">            |                    test and ref to xyzw</span>
<span class="sd">        :cri_specific_pars:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies other parameters specific to type of cri </span>
<span class="sd">            | (e.g. maxC for CQS calculations)</span>
<span class="sd">            |     - None: default to the one specified in  :cri_type: dict. </span>
<span class="sd">            |     - dict: user specified parameters. </span>
<span class="sd">            |         For its use, see for example:</span>
<span class="sd">            |             luxpy.cri._CRI_DEFAULTS[&#39;mcri&#39;][&#39;cri_specific_pars&#39;]</span>
<span class="sd">        :rg_pars: </span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Dict containing specifying parameters for slicing the gamut.</span>
<span class="sd">            | Dict structure: </span>
<span class="sd">            |     {&#39;nhbins&#39; : None, &#39;start_hue&#39; : 0, </span>
<span class="sd">            |       &#39;normalize_gamut&#39; : False, &#39;normalized_chroma_ref&#39;: 100.0}</span>
<span class="sd">            |    - key: &#39;nhbins&#39;: int, number of hue bins to slice gamut </span>
<span class="sd">            |                 (None use the one specified in :cri_type: dict).</span>
<span class="sd">            |    - key: &#39;start_hue&#39;: float (°), hue at which to start slicing</span>
<span class="sd">            |    - key: &#39;normalize_gamut&#39;: True or False: </span>
<span class="sd">            |                normalize gamut or not before calculating a gamut </span>
<span class="sd">            |                area index Rg. </span>
<span class="sd">            |    - key: &#39;normalized_chroma_ref&#39;: 100.0 or float, optional</span>
<span class="sd">            |                Controls the size (chroma/radius) </span>
<span class="sd">            |                of the normalization circle/gamut.</span>
<span class="sd">            |    - key &#39;use_bin_avg_DEi&#39;: True or False</span>
<span class="sd">            |               Note that following IES-TM30 DEhj from gamut_slicer()</span>
<span class="sd">            |               is obtained by averaging the DEi per hue bin (True),</span>
<span class="sd">            |               and NOT by averaging the jabt and jabr per hue bin </span>
<span class="sd">            |               and then calculating the DEhj (False).</span>
<span class="sd">        :avg: </span>
<span class="sd">            | None or fcn handle, optional</span>
<span class="sd">            | Averaging function (handle) for color differences, DEi </span>
<span class="sd">            | (e.g. numpy.mean, .math.rms, .math.geomean)</span>
<span class="sd">            | None use the one specified in :cri_type: dict.</span>
<span class="sd">        :scale:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies scaling of color differences to obtain CRI.</span>
<span class="sd">            |     - None use the one specified in :cri_type: dict.</span>
<span class="sd">            |     - dict: user specified dict with scaling parameters.</span>
<span class="sd">            |         - key: &#39;fcn&#39;: function handle to type of cri scale, </span>
<span class="sd">            |                 e.g. </span>
<span class="sd">            |                 * linear()_scale --&gt; (100 - scale_factor*DEi), </span>
<span class="sd">            |                 * log_scale --&gt; (cfr. Ohno&#39;s CQS), </span>
<span class="sd">            |                 * psy_scale (Smet et al.&#39;s cri2012,See: LRT 2013)</span>
<span class="sd">            |        - key: &#39;cfactor&#39;: factors used in scaling function, </span>
<span class="sd">            |              If None: </span>
<span class="sd">            |                     Scaling factor value(s) will be optimized to </span>
<span class="sd">            |                     minimize the rms between the Rf&#39;s of the </span>
<span class="sd">            |                     requested metric and the target metric specified</span>
<span class="sd">            |                     in:</span>
<span class="sd">            |</span>
<span class="sd">            |                  - key: &#39;opt_cri_type&#39;:  str </span>
<span class="sd">            |                      * str: one of the preset _CRI_DEFAULTS</span>
<span class="sd">            |                      * dict: user speciied </span>
<span class="sd">            |                      (dict must contain all keys as normal)</span>
<span class="sd">            |                     Note that if key not in :scale: dict, </span>
<span class="sd">            |                     then &#39;opt_cri_type&#39; is added with default </span>
<span class="sd">            |                     setting = &#39;ciera&#39;.</span>
<span class="sd">            |                 - key: &#39;opt_spd_set&#39;: ndarray with set of light </span>
<span class="sd">            |                     source spds used to optimize cfactor. </span>
<span class="sd">            |                     Note that if key not in :scale: dict, </span>
<span class="sd">            |                     then default = &#39;F1-F12&#39;.</span>
<span class="sd">        :fit_gamut_ellipse:</span>
<span class="sd">            | fit ellipse to normalized color gamut </span>
<span class="sd">            | (extract from function using out; also stored in hue_bin_data[&#39;gamut_ellipse_fit&#39;])</span>

<span class="sd">    Returns:</span>
<span class="sd">        :returns:</span>
<span class="sd">            | float or ndarray with Rg for :out: &#39;Rg&#39;</span>
<span class="sd">            | Other output is also possible by changing the :out: str value.</span>
<span class="sd">            | E.g. out == &#39;Rg,data&#39; would output an ndarray with Rg values </span>
<span class="sd">            |               and a dictionary :data: with keys:</span>
<span class="sd">            |                   &#39;St&#39;, &#39;Sr&#39;, &#39;cct&#39;, &#39;duv&#39;, &#39;hue_bin_data&#39; </span>
<span class="sd">            |                   &#39;xyzti&#39;, xyzti, &#39;xyztw&#39;, &#39;xyzri&#39;, &#39;xyzrw&#39;</span>
<span class="sd">            </span>
<span class="sd">    References:</span>
<span class="sd">        1. `IES TM30, Method for Evaluating Light Source Color Rendition. </span>
<span class="sd">        New York, NY: The Illuminating Engineering Society of North America.</span>
<span class="sd">        &lt;https://www.ies.org/store/technical-memoranda/ies-method-for-evaluating-light-source-color-rendition/&gt;`_</span>
<span class="sd">        </span>
<span class="sd">        2. `A. David, P. T. Fini, K. W. Houser, Y. Ohno, M. P. Royer, K. A. G. Smet, M. Wei, and L. Whitehead, </span>
<span class="sd">        “Development of the IES method for evaluating the color rendition of light sources,” </span>
<span class="sd">        Opt. Express, vol. 23, no. 12, pp. 15888–15906, 2015. </span>
<span class="sd">        &lt;https://www.osapublishing.org/oe/abstract.cfm?uri=oe-23-12-15888&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Override input parameters with data specified in cri_type:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>
    <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri.spd_to_rg&#39;</span><span class="p">)</span>

    <span class="c1">#avg, catf, cieobs, cieobs_cct, cri_specific_pars, cspace, cspace_pars, ref_type, rf_from_avg_rounded_rfi, rg_pars, sampleset, scale_factor, scale_fcn = [cri_type[x] for x in sorted(cri_type.keys())] </span>

       
    <span class="c1"># calculate Jabt of test and Jabr of the reference illuminant corresponding to test: </span>
    <span class="p">(</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span>
     <span class="n">xyzti</span><span class="p">,</span><span class="n">xyztw</span><span class="p">,</span>
     <span class="n">xyzri</span><span class="p">,</span><span class="n">xyzrw</span><span class="p">,</span>
     <span class="n">xyztw_cct</span><span class="p">,</span>
     <span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span><span class="p">)</span> <span class="o">=</span> <span class="n">spd_to_jab_t_r</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">,</span> 
                                          <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;jabt,jabr,xyzti,xyztw,xyzri,xyzrw,xyztw_cct,cct,duv,St,Sr&#39;</span><span class="p">)</span> 

    <span class="c1"># calculate gamut area index:</span>
    <span class="n">rg_pars</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;rg_pars&#39;</span><span class="p">]</span> 
    <span class="k">if</span> <span class="s1">&#39;use_bin_avg_DEi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rg_pars</span><span class="p">:</span> <span class="n">rg_pars</span><span class="p">[</span><span class="s1">&#39;use_bin_avg_DEi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">nhbins</span><span class="p">,</span> <span class="n">normalize_gamut</span><span class="p">,</span> <span class="n">normalized_chroma_ref</span><span class="p">,</span> <span class="n">start_hue</span><span class="p">,</span> <span class="n">use_bin_avg_DEi</span>  <span class="o">=</span> <span class="p">[</span><span class="n">rg_pars</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rg_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
    
    <span class="c1"># get hue_bin_data:</span>
    <span class="n">hue_bin_data</span> <span class="o">=</span> <span class="n">_get_hue_bin_data</span><span class="p">(</span><span class="n">jabt</span><span class="p">,</span> <span class="n">jabr</span><span class="p">,</span> 
                                    <span class="n">start_hue</span> <span class="o">=</span> <span class="n">start_hue</span><span class="p">,</span> <span class="n">nhbins</span> <span class="o">=</span> <span class="n">nhbins</span><span class="p">,</span>
                                    <span class="n">normalized_chroma_ref</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="p">)</span>
    
    <span class="n">Rg</span> <span class="o">=</span> <span class="n">_hue_bin_data_to_rg</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">,</span> <span class="n">normalize_gamut</span> <span class="o">=</span> <span class="n">normalize_gamut</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">fit_gamut_ellipse</span><span class="p">:</span>
        <span class="n">gamut_ellipse_fit</span> <span class="o">=</span> <span class="n">_hue_bin_data_to_ellipsefit</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">)</span>
        <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;gamut_ellipse_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamut_ellipse_fit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gamut_ellipse_fit</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;St&#39;</span> <span class="p">:</span> <span class="n">St</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span> <span class="p">:</span> <span class="n">Sr</span><span class="p">,</span> <span class="s1">&#39;xyztw_cct&#39;</span> <span class="p">:</span> <span class="n">xyztw_cct</span><span class="p">,</span> 
                <span class="s1">&#39;cct&#39;</span> <span class="p">:</span> <span class="n">cct</span><span class="p">,</span> <span class="s1">&#39;duv&#39;</span> <span class="p">:</span> <span class="n">duv</span><span class="p">,</span>
                <span class="s1">&#39;xyzti&#39;</span> <span class="p">:</span> <span class="n">xyzti</span><span class="p">,</span> <span class="s1">&#39;xyztw&#39;</span> <span class="p">:</span> <span class="n">xyztw</span><span class="p">,</span> 
                <span class="s1">&#39;xyzri&#39;</span> <span class="p">:</span> <span class="n">xyzri</span><span class="p">,</span> <span class="s1">&#39;xyzrw&#39;</span> <span class="p">:</span> <span class="n">xyzrw</span><span class="p">,</span>
                <span class="s1">&#39;Rg&#39;</span> <span class="p">:</span> <span class="n">Rg</span><span class="p">,</span> 
                <span class="s1">&#39;hue_bin_data&#39;</span> <span class="p">:</span> <span class="n">hue_bin_data</span><span class="p">,</span>
                <span class="s1">&#39;cri_type&#39;</span> <span class="p">:</span> <span class="n">cri_type</span><span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rg&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rg</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rg,data&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rg</span><span class="p">,</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rg,jabt,jabr,xyzti,xyztw,xyzri,xyzrw,xyztw_cct,cct,duv,St,Sr&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rg</span><span class="p">,</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">xyzti</span><span class="p">,</span><span class="n">xyztw</span><span class="p">,</span><span class="n">xyzri</span><span class="p">,</span><span class="n">xyzrw</span><span class="p">,</span><span class="n">xyztw_cct</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

    
<span class="c1">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="spd_to_cri">
<a class="viewcode-back" href="../../../../../color.html#luxpy.color.cri.spd_to_cri">[docs]</a>
<span class="k">def</span> <span class="nf">spd_to_cri</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">_CRI_TYPE_DEFAULT</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Rf&#39;</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
               <span class="n">sampleset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cieobs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
               <span class="n">avg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rf_from_avg_rounded_rfi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
               <span class="n">scale</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">opt_scale_factor</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cspace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">catf</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>\
               <span class="n">cri_specific_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rg_pars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fit_gamut_ellipse</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the color rendering fidelity index, Rf, of spectral data. </span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :St: </span>
<span class="sd">            | ndarray with spectral data </span>
<span class="sd">            | (can be multiple SPDs, first axis are the wavelengths)</span>
<span class="sd">        :out: </span>
<span class="sd">            | &#39;Rf&#39; or str, optional</span>
<span class="sd">            | Specifies requested output (e.g. &#39;Rf,cct,duv&#39;) </span>
<span class="sd">        :wl: </span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Wavelengths (or [start, end, spacing]) to interpolate the SPDs to. </span>
<span class="sd">            | None: default to no interpolation</span>
<span class="sd">        :cri_type:</span>
<span class="sd">            | _CRI_TYPE_DEFAULT or str or dict, optional</span>
<span class="sd">            |   -&#39;str: specifies dict with default cri model parameters </span>
<span class="sd">            |     (for supported types, see luxpy.cri._CRI_DEFAULTS[&#39;cri_types&#39;])</span>
<span class="sd">            |   - dict: user defined model parameters </span>
<span class="sd">            |     (see e.g. luxpy.cri._CRI_DEFAULTS[&#39;cierf&#39;] </span>
<span class="sd">            |     for required structure)</span>
<span class="sd">            | Note that any non-None input arguments to the function will </span>
<span class="sd">            | override default values in cri_type dict.</span>
<span class="sd">        :sampleset:</span>
<span class="sd">            | None or ndarray or str, optional</span>
<span class="sd">            | Specifies set of spectral reflectance samples for cri calculations.</span>
<span class="sd">            |     - None defaults to standard set for metric in cri_type.</span>
<span class="sd">            |     - ndarray: user defined set of spectral reflectance functions </span>
<span class="sd">            |       (.shape = (N+1, number of wavelengths); </span>
<span class="sd">            |        first axis are wavelengths)</span>
<span class="sd">        :ref_type:</span>
<span class="sd">            | None or str or ndarray, optional</span>
<span class="sd">            | Specifies type of reference illuminant type.</span>
<span class="sd">            |     - None: defaults to metric_specific reference illuminant in </span>
<span class="sd">            |             accordance with cri_type.</span>
<span class="sd">            |     - str: &#39;BB&#39; : Blackbody radiatiors, </span>
<span class="sd">            |            &#39;DL&#39;: daylightphase, </span>
<span class="sd">            |            &#39;ciera&#39;: used in CIE CRI-13.3-1995, </span>
<span class="sd">            |            &#39;cierf&#39;: used in CIE 224-2017, </span>
<span class="sd">            |            &#39;iesrf&#39;: used in TM30-15, ...</span>
<span class="sd">            |     - ndarray: user defined reference SPD</span>
<span class="sd">        :cieobs:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which CMF sets to use for the calculation of the sample </span>
<span class="sd">            | XYZs and the CCT (for reference illuminant calculation).</span>
<span class="sd">            | None defaults to the one specified in :cri_type: dict.    </span>
<span class="sd">            |     - key: &#39;xyz&#39;: str specifying CMF set for calculating xyz </span>
<span class="sd">            |                   of samples and white </span>
<span class="sd">            |     - key: &#39;cct&#39;: str specifying CMF set for calculating cct</span>
<span class="sd">        :cspace:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies which color space to use.</span>
<span class="sd">            | None defaults to the one specified in  :cri_type: dict.  </span>
<span class="sd">            |     - key: &#39;type&#39;: str specifying color space used to calculate </span>
<span class="sd">            |                    color differences in.</span>
<span class="sd">            |     - key: &#39;xyzw&#39;: None or ndarray with white point of color space</span>
<span class="sd">            |            If None: use xyzw of test / reference (after chromatic </span>
<span class="sd">            |                     adaptation, if specified)</span>
<span class="sd">            |     - other keys specify other possible parameters needed for color</span>
<span class="sd">            |       space calculation, </span>
<span class="sd">            |       see lx.cri._CRI_DEFAULTS[&#39;iesrf&#39;][&#39;cspace&#39;] for details. </span>
<span class="sd">        :catf:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Perform explicit CAT before converting to color space coordinates.</span>
<span class="sd">            |    - None: don&#39;t apply a cat (other than perhaps the one built </span>
<span class="sd">            |            into the colorspace) </span>
<span class="sd">            |    - dict: with CAT parameters:</span>
<span class="sd">            |        - key: &#39;D&#39;: ndarray with degree of adaptation</span>
<span class="sd">            |        - key: &#39;mcat&#39;: ndarray with sensor matrix specification</span>
<span class="sd">            |        - key: &#39;xyzw&#39;: None or ndarray with white point</span>
<span class="sd">            |              None: use xyzw of reference otherwise transform both </span>
<span class="sd">            |                    test and ref to xyzw</span>
<span class="sd">        :cri_specific_pars:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies other parameters specific to type of cri </span>
<span class="sd">            | (e.g. maxC for CQS calculations)</span>
<span class="sd">            |     - None: default to the one specified in  :cri_type: dict. </span>
<span class="sd">            |     - dict: user specified parameters. </span>
<span class="sd">            |         For its use, see for example:</span>
<span class="sd">            |             luxpy.cri._CRI_DEFAULTS[&#39;mcri&#39;][&#39;cri_specific_pars&#39;]</span>
<span class="sd">        :rg_pars: </span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Dict containing specifying parameters for slicing the gamut </span>
<span class="sd">            | and calculating hue bin specific indices.</span>
<span class="sd">            | Dict structure: </span>
<span class="sd">            |     {&#39;nhbins&#39; : None, &#39;start_hue&#39; : 0, </span>
<span class="sd">            |       &#39;normalize_gamut&#39; : False, &#39;normalized_chroma_ref&#39;: 100.0}</span>
<span class="sd">            |    - key: &#39;nhbins&#39;: int, number of hue bins to slice gamut </span>
<span class="sd">            |                 (None use the one specified in :cri_type: dict).</span>
<span class="sd">            |    - key: &#39;start_hue&#39;: float (°), hue at which to start slicing</span>
<span class="sd">            |    - key: &#39;normalize_gamut&#39;: True or False: </span>
<span class="sd">            |                normalize gamut or not before calculating a gamut </span>
<span class="sd">            |                area index Rg. </span>
<span class="sd">            |    - key: &#39;normalized_chroma_ref&#39;: 100.0 or float, optional</span>
<span class="sd">            |                Controls the size (chroma/radius) </span>
<span class="sd">            |                of the normalization circle/gamut.</span>
<span class="sd">            |    - key &#39;use_bin_avg_DEi&#39;: True or False</span>
<span class="sd">            |               Note that following IES-TM30 DEhj from gamut_slicer()</span>
<span class="sd">            |               is obtained by averaging the DEi per hue bin (True),</span>
<span class="sd">            |               and NOT by averaging the jabt and jabr per hue bin </span>
<span class="sd">            |               and then calculating the DEhj (False).</span>
<span class="sd">        :avg: </span>
<span class="sd">            | None or fcn handle, optional</span>
<span class="sd">            | Averaging function (handle) for color differences, DEi </span>
<span class="sd">            | (e.g. numpy.mean, .math.rms, .math.geomean)</span>
<span class="sd">            | None use the one specified in :cri_type: dict.</span>
<span class="sd">        :rf_from_avg_rounded_rfi:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | If None: use as specified in the :cri_type: dict</span>
<span class="sd">            | If False: calculate Rf directly from DEa.</span>
<span class="sd">            | If True: round Rfi to integer numbers and average them to Rf</span>
<span class="sd">            |           (method used in CIE-13.3-1995 Ra calculation)</span>
<span class="sd">        :scale:</span>
<span class="sd">            | None or dict, optional</span>
<span class="sd">            | Specifies scaling of color differences to obtain CRI.</span>
<span class="sd">            |     - None use the one specified in :cri_type: dict.</span>
<span class="sd">            |     - dict: user specified dict with scaling parameters.</span>
<span class="sd">            |         - key: &#39;fcn&#39;: function handle to type of cri scale, </span>
<span class="sd">            |                 e.g. </span>
<span class="sd">            |                 * linear_scale --&gt; (100 - scale_factor*DEi), </span>
<span class="sd">            |                 * log_scale --&gt; (cfr. Ohno&#39;s CQS), </span>
<span class="sd">            |                 * psy_scale (Smet et al.&#39;s cri2012,See: LRT 2013)</span>
<span class="sd">            |        - key: &#39;cfactor&#39;: factors used in scaling function, </span>
<span class="sd">            |              If None: </span>
<span class="sd">            |                     Scaling factor value(s) will be optimized to </span>
<span class="sd">            |                     minimize the rms between the Rf&#39;s of the </span>
<span class="sd">            |                     requested metric and the target metric specified</span>
<span class="sd">            |                     in:</span>
<span class="sd">            |</span>
<span class="sd">            |                  - key: &#39;opt_cri_type&#39;:  str </span>
<span class="sd">            |                      * str: one of the preset _CRI_DEFAULTS</span>
<span class="sd">            |                      * dict: user speciied </span>
<span class="sd">            |                      (dict must contain all keys as normal)</span>
<span class="sd">            |                     Note that if key not in :scale: dict, </span>
<span class="sd">            |                     then &#39;opt_cri_type&#39; is added with default </span>
<span class="sd">            |                     setting = &#39;ciera&#39;.</span>
<span class="sd">            |                 - key: &#39;opt_spd_set&#39;: ndarray with set of light </span>
<span class="sd">            |                     source spds used to optimize cfactor. </span>
<span class="sd">            |                     Note that if key not in :scale: dict, </span>
<span class="sd">            |                     then default = &#39;F1-F12&#39;.</span>
<span class="sd">        :opt_scale_factor: </span>
<span class="sd">            | True or False, optional</span>
<span class="sd">            | True: optimize scaling-factor, else do nothing and use value of </span>
<span class="sd">            | scaling-factor in :scale: dict.   </span>
<span class="sd">        :fit_gamut_ellipse:</span>
<span class="sd">            | fit ellipse to normalized color gamut </span>
<span class="sd">            | (extract from function using out; also stored in hue_bin_data[&#39;gamut_ellipse_fit&#39;])</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: </span>
<span class="sd">            | float or ndarray with Rf for :out: &#39;Rf&#39;</span>
<span class="sd">            | Other output is also possible by changing the :out: str value.</span>
<span class="sd">            | E.g. out == &#39;Rg,data&#39; would output an ndarray with Rf values </span>
<span class="sd">            | </span>
<span class="sd">            | and a dictionary :data: with keys:</span>
<span class="sd">            | </span>
<span class="sd">            | - &#39;St, Sr&#39;  : ndarray of test SPDs and corresponding ref. illuminants.</span>
<span class="sd">            | - &#39;xyz_cct&#39;: xyz of white point calculate with cieobs defined for cct calculations in cri_type[&#39;cieobs&#39;]</span>
<span class="sd">            | - &#39;cct, duv&#39;: CCT and Duv obtained with cieobs in cri_type[&#39;cieobs&#39;][&#39;cct&#39;]</span>
<span class="sd">            | - &#39;xyzti, xyzri&#39;: ndarray tristimulus values of test and ref. samples (obtained with with cieobs in cri_type[&#39;cieobs&#39;][&#39;xyz&#39;])</span>
<span class="sd">            | - &#39;xyztw, xyzrw&#39;: ndarray tristimulus values of test and ref. white points (obtained with with cieobs in cri_type[&#39;cieobs&#39;][&#39;xyz&#39;])</span>
<span class="sd">            | - &#39;DEi, DEa&#39;: ndarray with individual sample color differences DEi and average DEa between test and ref.       </span>
<span class="sd">            | - &#39;Rf&#39;  : ndarray with general color fidelity index values</span>
<span class="sd">            | - &#39;Rg&#39;  : ndarray with color gamut area index values</span>
<span class="sd">            | - &#39;Rfi&#39;  : ndarray with specific (sample) color fidelity indices</span>
<span class="sd">            | - &#39;Rfhj&#39; : ndarray with local (hue binned) fidelity indices</span>
<span class="sd">            | - &#39;DEhj&#39; : ndarray with local (hue binned) color differences</span>
<span class="sd">            | - &#39;Rcshj&#39;: ndarray with local chroma shifts indices</span>
<span class="sd">            | - &#39;Rhshj&#39;: ndarray with local hue shifts indices</span>
<span class="sd">            | - &#39;hue_bin_data&#39;: dict with output from _get_hue_bin_data() [see its help for more info]</span>
<span class="sd">            | - &#39;cri_type&#39;: same as input (for reference purposes)</span>
<span class="sd">            </span>
<span class="sd">    References:</span>
<span class="sd">        1. `IES TM30, Method for Evaluating Light Source Color Rendition. </span>
<span class="sd">        New York, NY: The Illuminating Engineering Society of North America.</span>
<span class="sd">        &lt;https://www.ies.org/store/technical-memoranda/ies-method-for-evaluating-light-source-color-rendition/&gt;`_</span>
<span class="sd">        </span>
<span class="sd">        2. `A. David, P. T. Fini, K. W. Houser, Y. Ohno, M. P. Royer, K. A. G. Smet, M. Wei, and L. Whitehead, </span>
<span class="sd">        “Development of the IES method for evaluating the color rendition of light sources,” </span>
<span class="sd">        Opt. Express, vol. 23, no. 12, pp. 15888–15906, 2015. </span>
<span class="sd">        &lt;https://www.osapublishing.org/oe/abstract.cfm?uri=oe-23-12-15888&gt;`_</span>
<span class="sd">        </span>
<span class="sd">        3. `CIE224:2017. CIE 2017 Colour Fidelity Index for accurate scientific use. </span>
<span class="sd">        Vienna, Austria: CIE. (2017).</span>
<span class="sd">        &lt;http://www.cie.co.at/index.php?i_ca_id=1027&gt;`_</span>
<span class="sd">        </span>
<span class="sd">        4. `Smet, K., Schanda, J., Whitehead, L., &amp; Luo, R. (2013). </span>
<span class="sd">        CRI2012: A proposal for updating the CIE colour rendering index. </span>
<span class="sd">        Lighting Research and Technology, 45, 689–709. </span>
<span class="sd">        &lt;http://lrt.sagepub.com/content/45/6/689&gt;`_</span>
<span class="sd">        </span>
<span class="sd">        5. `CIE13.3-1995. Method of Measuring and Specifying </span>
<span class="sd">        Colour Rendering Properties of Light Sources </span>
<span class="sd">        (Vol. CIE13.3-19). Vienna, Austria: CIE. (1995).</span>
<span class="sd">        &lt;http://www.cie.co.at/index.php/index.php?i_ca_id=303&gt;`_</span>
<span class="sd">                    </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outlist</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    
    <span class="c1">#Override input parameters with data specified in cri_type:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span> <span class="c1"># get dict with keyword input arguments to function (used to overwrite non-None input arguments present in cri_type dict)</span>

    <span class="n">cri_type</span> <span class="o">=</span> <span class="n">process_cri_type_input</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">callerfunction</span> <span class="o">=</span> <span class="s1">&#39;cri.spd_to_cri&#39;</span><span class="p">)</span>
    
    <span class="c1"># unpack some keys:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt_scale_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">opt_scale_factor</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;cfactor&#39;</span><span class="p">]</span>
    <span class="n">scale_fcn</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="s1">&#39;fcn&#39;</span><span class="p">]</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">]</span>  
    <span class="n">rf_from_avg_rounded_rfi</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;rf_from_avg_rounded_rfi&#39;</span><span class="p">]</span>
    
    <span class="c1"># Input parsing: optimize scale_factor for input based on F1-F12 (default) if scale_factor is NaN or None:</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">optimize_scale_factor</span><span class="p">(</span><span class="n">cri_type</span><span class="p">,</span><span class="n">opt_scale_factor</span><span class="p">,</span> <span class="n">scale_fcn</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s1">&#39;Unable to optimize scale_factor.&#39;</span><span class="p">)</span>

    <span class="c1"># A. get DEi of for ciera and of requested cri metric for spds in or specified by scale_factor_optimization_spds&#39;:</span>
    <span class="c1"># calculate Jabt of test and Jabr of the reference illuminant corresponding to test: </span>
    <span class="p">(</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span>
     <span class="n">xyzti</span><span class="p">,</span><span class="n">xyztw</span><span class="p">,</span>
     <span class="n">xyzri</span><span class="p">,</span><span class="n">xyzrw</span><span class="p">,</span>
     <span class="n">xyztw_cct</span><span class="p">,</span>
     <span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span><span class="p">)</span> <span class="o">=</span> <span class="n">spd_to_jab_t_r</span><span class="p">(</span><span class="n">St</span><span class="p">,</span> <span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">,</span> <span class="n">cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">,</span> 
                                          <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;jabt,jabr,xyzti,xyztw,xyzri,xyzrw,xyztw_cct,cct,duv,St,Sr&#39;</span><span class="p">)</span> 

    <span class="c1"># E. calculate DEi, DEa:</span>
    <span class="n">DEi</span> <span class="o">=</span> <span class="p">((</span><span class="n">jabt</span> <span class="o">-</span> <span class="n">jabr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">DEa</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">DEi</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="c1"># B. convert DEi to color rendering index:</span>
    <span class="n">Rfi</span> <span class="o">=</span> <span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEi</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rf_from_avg_rounded_rfi</span><span class="p">:</span>
        <span class="n">Rf</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">(</span><span class="n">scale_fcn</span><span class="p">(</span><span class="n">DEa</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Rf</span> <span class="o">=</span> <span class="n">np2d</span><span class="p">(</span><span class="n">avg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Rfi</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="c1"># as in CIE 13.3-1995 Ra calculation !!! </span>
    
    <span class="c1"># C. get binned jabt jabr and DEi:</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Rg&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Rfhj&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;DEhj&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span> \
       <span class="p">(</span><span class="s1">&#39;Rhshj&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;Rcshj&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="s1">&#39;hue_bin_data&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span>\
       <span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">outlist</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fit_gamut_ellipse</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        
        <span class="n">rg_pars</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">[</span><span class="s1">&#39;rg_pars&#39;</span><span class="p">]</span> 
        <span class="k">if</span> <span class="s1">&#39;use_bin_avg_DEi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rg_pars</span><span class="p">:</span> <span class="n">rg_pars</span><span class="p">[</span><span class="s1">&#39;use_bin_avg_DEi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nhbins</span><span class="p">,</span> <span class="n">normalize_gamut</span><span class="p">,</span> <span class="n">normalized_chroma_ref</span><span class="p">,</span> <span class="n">start_hue</span><span class="p">,</span> <span class="n">use_bin_avg_DEi</span>  <span class="o">=</span> <span class="p">[</span><span class="n">rg_pars</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rg_pars</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        
        <span class="c1"># get hue_bin_data:</span>
        <span class="n">hue_bin_data</span> <span class="o">=</span> <span class="n">_get_hue_bin_data</span><span class="p">(</span><span class="n">jabt</span><span class="p">,</span> <span class="n">jabr</span><span class="p">,</span> 
                                    <span class="n">start_hue</span> <span class="o">=</span> <span class="n">start_hue</span><span class="p">,</span> <span class="n">nhbins</span> <span class="o">=</span> <span class="n">nhbins</span><span class="p">,</span>
                                    <span class="n">normalized_chroma_ref</span> <span class="o">=</span> <span class="n">normalized_chroma_ref</span><span class="p">)</span>
        <span class="c1"># Calculate color gamut area index, Rg:</span>
        <span class="n">Rg</span> <span class="o">=</span> <span class="n">_hue_bin_data_to_rg</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">,</span> <span class="n">normalize_gamut</span> <span class="o">=</span> <span class="n">normalize_gamut</span><span class="p">)</span>
        
        <span class="c1"># Fit an ellipse to the normalized color gamut:</span>
        <span class="k">if</span> <span class="n">fit_gamut_ellipse</span><span class="p">:</span>
            <span class="n">gamut_ellipse_fit</span> <span class="o">=</span> <span class="n">_hue_bin_data_to_ellipsefit</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">)</span>
            <span class="n">hue_bin_data</span><span class="p">[</span><span class="s1">&#39;gamut_ellipse_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamut_ellipse_fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gamut_ellipse_fit</span> <span class="o">=</span> <span class="p">{}</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Rg</span><span class="p">,</span> <span class="n">hue_bin_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>


    <span class="c1"># D. # Calculate local fidelity, chroma shifts and hue shifts:</span>
    <span class="k">if</span> <span class="n">hue_bin_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Rcshj</span><span class="p">,</span> <span class="n">Rhshj</span><span class="p">,</span> <span class="n">Rfhj</span><span class="p">,</span> <span class="n">DEhj</span> <span class="o">=</span> <span class="n">_hue_bin_data_to_rxhj</span><span class="p">(</span><span class="n">hue_bin_data</span><span class="p">,</span> 
                                                         <span class="n">scale_fcn</span> <span class="o">=</span> <span class="n">scale_fcn</span><span class="p">,</span>
                                                         <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">,</span>
                                                         <span class="n">cri_type</span> <span class="o">=</span> <span class="n">cri_type</span><span class="p">,</span>
                                                         <span class="n">use_bin_avg_DEi</span> <span class="o">=</span> <span class="n">use_bin_avg_DEi</span><span class="p">)</span>


    <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;St&#39;</span> <span class="p">:</span> <span class="n">St</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span> <span class="p">:</span> <span class="n">Sr</span><span class="p">,</span> <span class="s1">&#39;xyztw_cct&#39;</span> <span class="p">:</span> <span class="n">xyztw_cct</span><span class="p">,</span>
                <span class="s1">&#39;cct&#39;</span> <span class="p">:</span> <span class="n">cct</span><span class="p">,</span> <span class="s1">&#39;duv&#39;</span> <span class="p">:</span> <span class="n">duv</span><span class="p">,</span>
                <span class="s1">&#39;xyzti&#39;</span> <span class="p">:</span> <span class="n">xyzti</span><span class="p">,</span> <span class="s1">&#39;xyztw&#39;</span> <span class="p">:</span> <span class="n">xyztw</span><span class="p">,</span> 
                <span class="s1">&#39;xyzri&#39;</span> <span class="p">:</span> <span class="n">xyzri</span><span class="p">,</span> <span class="s1">&#39;xyzrw&#39;</span> <span class="p">:</span> <span class="n">xyzrw</span><span class="p">,</span>
                <span class="s1">&#39;DEi&#39;</span> <span class="p">:</span> <span class="n">DEi</span><span class="p">,</span> <span class="s1">&#39;DEa&#39;</span> <span class="p">:</span> <span class="n">DEa</span><span class="p">,</span>
                <span class="s1">&#39;Rf&#39;</span> <span class="p">:</span> <span class="n">Rf</span><span class="p">,</span> <span class="s1">&#39;Rg&#39;</span> <span class="p">:</span> <span class="n">Rg</span><span class="p">,</span> <span class="s1">&#39;Rfi&#39;</span> <span class="p">:</span> <span class="n">Rfi</span><span class="p">,</span>
                <span class="s1">&#39;Rcshj&#39;</span> <span class="p">:</span> <span class="n">Rcshj</span><span class="p">,</span> <span class="s1">&#39;Rhshj&#39;</span> <span class="p">:</span> <span class="n">Rhshj</span><span class="p">,</span> <span class="s1">&#39;Rfhj&#39;</span> <span class="p">:</span> <span class="n">Rfhj</span><span class="p">,</span>
                <span class="s1">&#39;hue_bin_data&#39;</span> <span class="p">:</span> <span class="n">hue_bin_data</span><span class="p">,</span>
                <span class="s1">&#39;cri_type&#39;</span> <span class="p">:</span> <span class="n">cri_type</span><span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rf&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rf</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rf,Rg&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rf</span><span class="p">,</span> <span class="n">Rg</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rf,data&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rf</span><span class="p">,</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">out</span> <span class="o">==</span> <span class="s1">&#39;Rf,Rg,jabt,jabr,xyzti,xyztw,xyzri,xyzrw,cct,duv,St,Sr&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Rf</span><span class="p">,</span><span class="n">Rg</span><span class="p">,</span><span class="n">jabt</span><span class="p">,</span><span class="n">jabr</span><span class="p">,</span><span class="n">xyzti</span><span class="p">,</span><span class="n">xyztw</span><span class="p">,</span><span class="n">xyzri</span><span class="p">,</span><span class="n">xyzrw</span><span class="p">,</span><span class="n">cct</span><span class="p">,</span><span class="n">duv</span><span class="p">,</span><span class="n">St</span><span class="p">,</span><span class="n">Sr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<span class="c1"># For testing:</span>
<span class="c1"># from luxpy import _CIE_F4, _CIE_D65, _IESTM3018</span>

<span class="c1"># F4 = cie_interp(_CIE_F4, wl_new=[360,830,1], kind = &#39;spd&#39;)</span>
<span class="c1"># D65 = cie_interp(_CIE_D65, wl_new=[360,830,1], kind = &#39;spd&#39;)</span>
<span class="c1"># out = spd_to_cri(np.vstack((F4,D65[1:])), out = &#39;Rf,Rg,data&#39;) #, </span>
<span class="c1">#                  # opt_scale_factor = True, </span>
<span class="c1">#                  # scale = {&#39;fcn&#39;:log_scale, </span>
<span class="c1">#                  #          &#39;cfactor&#39;:[None],</span>
<span class="c1">#                  #          &#39;opt_spd_set&#39; : _IESTM3018[&#39;S&#39;][&#39;data&#39;][:100,:].copy() })</span>
<span class="c1"># print(out[:2])</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Kevin A.G. Smet.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>