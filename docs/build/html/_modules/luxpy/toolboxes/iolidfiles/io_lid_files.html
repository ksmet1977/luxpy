

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>luxpy.toolboxes.iolidfiles.io_lid_files &mdash; LuxPy 1.7.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> LuxPy
          

          
          </a>

          
            
            
              <div class="version">
                1.7.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../license.html">License: GPLv3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../required_packages.html">Imported (required) packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../luxpy_structure.html">Luxpy package structure</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">LuxPy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>luxpy.toolboxes.iolidfiles.io_lid_files</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for luxpy.toolboxes.iolidfiles.io_lid_files</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">########################################################################</span>
<span class="c1"># &lt;LUXPY: a Python package for lighting and color science.&gt;</span>
<span class="c1"># Copyright (C) &lt;2017&gt;  &lt;Kevin A.G. Smet&gt; (ksmet1977 at gmail.com)</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c1">#########################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for reading / writing LID data from IES and LDT files.</span>
<span class="sd">=============================================================</span>

<span class="sd"> :read_lamp_data(): Read in light intensity distribution and other lamp data from LDT or IES files.</span>

<span class="sd"> :get_uv_texture(): Create a uv-texture map for use in renderings.</span>
<span class="sd"> </span>
<span class="sd"> :save_texture(): Save 16 bit grayscale PNG image of uv-texture.</span>
<span class="sd"> </span>
<span class="sd"> :draw_lid(): Draw 2D polar plots or 3D light intensity distribution.</span>
<span class="sd"> </span>
<span class="sd"> :render_lid(): Render a light intensity distribution.</span>

<span class="sd">    Notes:</span>
<span class="sd">        1. Only basic support (reading / visualization). Writing is not yet implemented.</span>
<span class="sd">        2. Reading IES files is based on Blender&#39;s ies2cycles.py</span>
<span class="sd">        3. This was implemented to build some uv-texture maps for rendering and only tested for a few files.</span>
<span class="sd">        4. Use at own risk. No warranties. Still under test.</span>
<span class="sd">     </span>
<span class="sd">.. codeauthor:: Kevin A.G. Smet (ksmet1977 at gmail.com)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">luxpy.utils</span> <span class="kn">import</span> <span class="n">np</span><span class="p">,</span> <span class="n">_PKG_PATH</span><span class="p">,</span> <span class="n">_SEP</span>
<span class="kn">from</span> <span class="nn">luxpy.utils</span> <span class="kn">import</span> <span class="n">plt</span><span class="p">,</span> <span class="n">Axes3D</span> 

<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">matlib</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">interp</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="kn">import</span> <span class="nn">imageio</span>
<span class="n">imageio</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">freeimage</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
<span class="c1"># from skimage import exposure, img_as_uint</span>

<span class="n">_PATH_DATA</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_PKG_PATH</span><span class="p">,</span> <span class="s1">&#39;toolboxes&#39;</span><span class="p">,</span><span class="s1">&#39;iolidfiles&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">_SEP</span>

<span class="n">__all__</span> <span class="o">=</span><span class="p">[</span><span class="s1">&#39;_PATH_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;read_lamp_data&#39;</span><span class="p">,</span><span class="s1">&#39;get_uv_texture&#39;</span><span class="p">,</span><span class="s1">&#39;save_texture&#39;</span><span class="p">,</span><span class="s1">&#39;draw_lid&#39;</span><span class="p">,</span><span class="s1">&#39;render_lid&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_read_file</span><span class="p">(</span><span class="n">string_data</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string_data</span><span class="p">,</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">string_data</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;StringIO&#39;</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">string_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">string_data</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.ies&#39;</span><span class="p">,</span> <span class="s1">&#39;.ldt&#39;</span><span class="p">)):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">string_data</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="c1"># file = open(filename, &#39;rt&#39;, encoding=&#39;cp1252&#39;)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">string_data</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">string_data</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.ies&#39;</span><span class="p">,</span> <span class="s1">&#39;.ldt&#39;</span><span class="p">)):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">string_data</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;String&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid input (options: filename, StringIO object or string with LID data)&#39;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.ies&#39;</span> <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;TILT=&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;TILT =&#39;</span> <span class="ow">in</span> <span class="n">content</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;.ldt&#39;</span>
    <span class="k">return</span> <span class="n">content</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="n">ext</span>
        
        
    

<div class="viewcode-block" id="read_lamp_data"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.iolidfiles.read_lamp_data">[docs]</a><span class="k">def</span> <span class="nf">read_lamp_data</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="s1">&#39;I0&#39;</span><span class="p">,</span> <span class="n">only_common_keys</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in light intensity distribution and other lamp data from LDT or IES files.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :datasource:</span>
<span class="sd">            | Filename of LID file or StringIO object or string with LID data.</span>
<span class="sd">        :multiplier:</span>
<span class="sd">            | 1.0, optional</span>
<span class="sd">            | Scaler for candela values.</span>
<span class="sd">        :verbosity:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | Display messages while reading file.</span>
<span class="sd">        :normalize:</span>
<span class="sd">            | &#39;I0&#39;, optional</span>
<span class="sd">            | If &#39;I0&#39;: normalize LID to intensity at (theta,phi) = (0,0)</span>
<span class="sd">            | If &#39;max&#39;: normalize to max = 1.</span>
<span class="sd">        :only_common_keys:</span>
<span class="sd">            | False, optional</span>
<span class="sd">            | If True, output only common dict keys related to angles, values</span>
<span class="sd">            | and such of LID.</span>
<span class="sd">            | read_lid_lamp_data(?) for print of common keys and return</span>
<span class="sd">            |                       empty dict with common keys.</span>
<span class="sd">   </span>
<span class="sd">    Returns:</span>
<span class="sd">        :lid: dict with IES or LDT file data.</span>
<span class="sd">            |</span>
<span class="sd">            | If LIDtype == &#39;ies&#39;:</span>
<span class="sd">            |    dict_keys(</span>
<span class="sd">            | [&#39;datasource&#39;, &#39;version&#39;, &#39;lamps_num&#39;, &#39;lumens_per_lamp&#39;,</span>
<span class="sd">            | &#39;candela_mult&#39;, &#39;v_angles_num&#39;, &#39;h_angles_num&#39;, &#39;photometric_type&#39;,</span>
<span class="sd">            | &#39;units_type&#39;, &#39;width&#39;, &#39;length&#39;, &#39;height&#39;, &#39;ballast_factor&#39;, </span>
<span class="sd">            | &#39;future_use&#39;, &#39;input_watts&#39;, &#39;v_angs&#39;, &#39;h_angs&#39;, &#39;lamp_cone_type&#39;,</span>
<span class="sd">            | &#39;lamp_h_type&#39;, &#39;candela_values&#39;, &#39;candela_2d&#39;, &#39;v_same&#39;, &#39;h_same&#39;,</span>
<span class="sd">            | &#39;intensity&#39;, &#39;theta&#39;, &#39;values&#39;, &#39;phi&#39;, &#39;map&#39;,&#39;Iv0&#39;]</span>
<span class="sd">            | )</span>
<span class="sd">            |</span>
<span class="sd">            | If LIDtype == &#39;ldt&#39;:</span>
<span class="sd">            |    dict_keys(</span>
<span class="sd">            | [&#39;datasource&#39;, &#39;version&#39;, &#39;manufacturer&#39;, &#39;Ityp&#39;,&#39;Isym&#39;,</span>
<span class="sd">            | &#39;Mc&#39;, &#39;Dc&#39;, &#39;Ng&#39;, &#39;name&#39;, Dg&#39;, &#39;cct/cri&#39;, &#39;tflux&#39;, &#39;lumens_per_lamp&#39;,</span>
<span class="sd">            | &#39;candela_mult&#39;, &#39;tilt&#39;, lamps_num&#39;,</span>
<span class="sd">            | &#39;cangles&#39;, &#39;tangles&#39;,&#39;candela_values&#39;, &#39;candela_2d&#39;,</span>
<span class="sd">            | &#39;intensity&#39;, &#39;theta&#39;, &#39;values&#39;, &#39;phi&#39;, &#39;map&#39;, &#39;Iv0&#39;]</span>
<span class="sd">            | )</span>
<span class="sd">            </span>
<span class="sd">    Notes:</span>
<span class="sd">        1. if only_common_keys: output is dictionary with keys: [&#39;datasource&#39;, &#39;version&#39;, &#39;intensity&#39;, &#39;theta&#39;, &#39;phi&#39;, \</span>
<span class="sd">        &#39;values&#39;, &#39;map&#39;, &#39;Iv0&#39;, &#39;candela_values&#39;, &#39;candela_2d&#39;] </span>
<span class="sd">        2. &#39;theta&#39;,&#39;phi&#39;, &#39;values&#39; (=&#39;candela_2d&#39;) contain the original theta angles, phi angles and normalized candelas as specified in file.</span>
<span class="sd">        3. &#39;map&#39; contains a dicionary with keys &#39;thetas&#39;, &#39;phis&#39;, &#39;values&#39;. This data has been complete to full angle ranges thetas: [0,180]; phis: [0,360]   </span>
<span class="sd">        4. LDT map completion only supported for Isymm == 4 (31/10/2018), Map will be filled with original &#39;theta&#39;, &#39;phi&#39; and normalized &#39;candela_2d&#39; values !</span>
<span class="sd">        5. LIDtype is checked by looking for the presence of &#39;TILT=&#39; in datasource content (if True-&gt;&#39;IES&#39; else &#39;LDT&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">common_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datasource&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span> \
                   <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">,</span> <span class="s1">&#39;Iv0&#39;</span><span class="p">,</span> <span class="s1">&#39;candela_values&#39;</span><span class="p">,</span> <span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">datasource</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">common_keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">common_keys</span><span class="p">,[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">common_keys</span><span class="p">)))</span> 
    

    <span class="n">datasource</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">_read_file</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;ies&#39;</span><span class="p">:</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">read_IES_lamp_data</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">,</span> \
                                 <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">file_ext</span> <span class="o">==</span> <span class="s1">&#39;ldt&#39;</span><span class="p">:</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">read_ldt_lamp_data</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;read_lid_lamp_data(): </span><span class="si">{:s}</span><span class="s2"> --&gt; unsupported datasource type (only &#39;ies&#39; or &#39;ldt&#39;: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_ext</span><span class="p">))</span>
    <span class="n">lid</span><span class="p">[</span><span class="s1">&#39;datasource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span> <span class="c1"># overwrite with original as this key is set to String or StringIO on call to specific readl_lamp_data functions</span>
    
    <span class="k">if</span> <span class="n">only_common_keys</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lid</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">common_keys</span><span class="p">}</span>
    
    <span class="k">return</span> <span class="n">lid</span></div>
    
<span class="k">def</span> <span class="nf">displaymsg</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display messages (used by read_IES_lamp_data).  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
    
    

<span class="k">def</span> <span class="nf">read_IES_lamp_data</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="s1">&#39;I0&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in IES data (adapted from Blender&#39;s ies2cycles.py).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :datasource:</span>
<span class="sd">            | Filename of LID file or StringIO object or string with LID data.</span>
<span class="sd">        :multiplier:</span>
<span class="sd">            | 1.0, optional</span>
<span class="sd">            | Scaler for candela values.</span>
<span class="sd">        :verbosity:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | Display messages while reading data.</span>
<span class="sd">        :normalize:</span>
<span class="sd">            | &#39;I0&#39;, optional</span>
<span class="sd">            | If &#39;I0&#39;: normalize LID to intensity at (theta,phi) = (0,0)</span>
<span class="sd">            | If &#39;max&#39;: normalize to max = 1.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :IES: dict with IES data.</span>
<span class="sd">            |</span>
<span class="sd">            | dict_keys(</span>
<span class="sd">            | [&#39;datasource&#39;, &#39;version&#39;, &#39;lamps_num&#39;, &#39;lumens_per_lamp&#39;,</span>
<span class="sd">            | &#39;candela_mult&#39;, &#39;v_angles_num&#39;, &#39;h_angles_num&#39;, &#39;photometric_type&#39;,</span>
<span class="sd">            | &#39;units_type&#39;, &#39;width&#39;, &#39;length&#39;, &#39;height&#39;, &#39;ballast_factor&#39;, </span>
<span class="sd">            | &#39;future_use&#39;, &#39;input_watts&#39;, &#39;v_angs&#39;, &#39;h_angs&#39;, &#39;lamp_cone_type&#39;,</span>
<span class="sd">            | &#39;lamp_h_type&#39;, &#39;candela_values&#39;, &#39;candela_2d&#39;, &#39;v_same&#39;, &#39;h_same&#39;,</span>
<span class="sd">            | &#39;intensity&#39;, &#39;theta&#39;, &#39;values&#39;, &#39;phi&#39;, &#39;map&#39;,&#39;Iv0&#39;]</span>
<span class="sd">            | )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">version_table</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;IESNA:LM-63-1986&#39;</span><span class="p">:</span> <span class="mi">1986</span><span class="p">,</span>
        <span class="s1">&#39;IESNA:LM-63-1991&#39;</span><span class="p">:</span> <span class="mi">1991</span><span class="p">,</span>
        <span class="s1">&#39;IESNA91&#39;</span><span class="p">:</span> <span class="mi">1991</span><span class="p">,</span>
        <span class="s1">&#39;IESNA:LM-63-1995&#39;</span><span class="p">:</span> <span class="mi">1995</span><span class="p">,</span>
        <span class="s1">&#39;IESNA:LM-63-2002&#39;</span><span class="p">:</span> <span class="mi">2002</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="c1"># name = os.path.splitext(os.path.split(filename)[1])[0]</span>

    <span class="c1"># # file = open(filename, &#39;rt&#39;, encoding=&#39;cp1252&#39;)</span>
    <span class="c1"># file = open(filename, &#39;rt&#39;)</span>
    <span class="c1"># content = file.read()</span>
    <span class="c1"># file.close()</span>
    <span class="n">content</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">_read_file</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># get rid of path</span>
    <span class="n">s</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">version_table</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">version_table</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;IES file does not specify any version&quot;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">content</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">content</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TILT=&#39;</span><span class="p">):</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">):</span>
            <span class="n">endbracket</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">endbracket</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">keywords</span><span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">endbracket</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">endbracket</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">s</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;TILT&#39;</span><span class="p">):</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span> <span class="s2">&quot;TILT keyword not found, check your IES file&quot;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># fight against ill-formed files</span>
    <span class="n">file_data</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">lamps_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">lamps_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;Only 1 lamp is supported, </span><span class="si">%d</span><span class="s2"> in IES file&quot;</span> <span class="o">%</span> <span class="n">lamps_num</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
    
    <span class="n">lumens_per_lamp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">candela_mult</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="n">v_angles_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">h_angles_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">v_angles_num</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">h_angles_num</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s2">&quot;TILT keyword not found, check your IES file&quot;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">photometric_type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

    <span class="n">units_type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">units_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;Units type should be either 1 (feet) or 2 (meters)&quot;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

    <span class="n">width</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">file_data</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">10</span><span class="p">])</span>
    
    <span class="n">ballast_factor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>

    <span class="n">future_use</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">future_use</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;Invalid future use field&quot;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>

    <span class="n">input_watts</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">file_data</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>

    <span class="n">v_angs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">13</span> <span class="o">+</span> <span class="n">v_angles_num</span><span class="p">]]</span>
    <span class="n">h_angs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="mi">13</span> <span class="o">+</span> <span class="n">v_angles_num</span><span class="p">:</span>
                                          <span class="mi">13</span> <span class="o">+</span> <span class="n">v_angles_num</span> <span class="o">+</span> <span class="n">h_angles_num</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">v_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">lamp_cone_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE90&#39;</span>
    <span class="k">elif</span> <span class="n">v_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">v_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">180</span><span class="p">:</span>
        <span class="n">lamp_cone_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE180&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;Lamps with vertical angles (</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">) are not supported&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">v_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
        <span class="n">lamp_cone_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE180&#39;</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_angs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">360</span><span class="p">:</span>
        <span class="n">lamp_h_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE360&#39;</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">180</span><span class="p">:</span>
        <span class="n">lamp_h_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE180&#39;</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">h_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">90</span><span class="p">:</span>
        <span class="n">lamp_h_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE90&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;Lamps with horizontal angles (</span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">) are not supported&quot;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">h_angs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h_angs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
        <span class="n">lamp_h_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE360&#39;</span>
        

    <span class="c1"># read candela values</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_angs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_angs</span><span class="p">)</span>
    <span class="n">candela_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_angs</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_angs</span><span class="p">)</span>
    <span class="n">candela_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">file_data</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">candela_num</span><span class="p">]]</span>

    <span class="c1"># reshape 1d array to 2d array</span>
    <span class="n">candela_2d</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">candela_values</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_angs</span><span class="p">)))</span>

    <span class="c1"># check if angular offsets are the same</span>
    <span class="n">v_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">v_angs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_angs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_angs</span><span class="p">))]</span>
    <span class="n">h_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_angs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">h_angs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_angs</span><span class="p">))]</span>

    <span class="n">v_same</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_d</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_d</span><span class="p">)))</span>
    <span class="n">h_same</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">h_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">h_d</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_d</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">h_same</span><span class="p">:</span>
        <span class="n">displaymsg</span><span class="p">(</span><span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s2">&quot;Different offsets for horizontal angles!&quot;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span><span class="p">)</span>
        
    <span class="c1"># normalize candela values</span>
    <span class="n">maxval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">candela_2d</span><span class="p">])</span>
    <span class="n">candela_2d</span> <span class="o">=</span> <span class="p">[[</span><span class="n">val</span> <span class="o">/</span> <span class="n">maxval</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">candela_2d</span><span class="p">]</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">candela_mult</span>
    <span class="c1">#intensity = max(500, min(intensity, 5000)) #???</span>

    <span class="c1"># Summarize in dict():</span>
    <span class="n">IES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datasource&#39;</span><span class="p">:</span> <span class="n">datasource</span><span class="p">}</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamps_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamps_num</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lumens_per_lamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lumens_per_lamp</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_mult&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candela_mult</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;v_angles_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_angles_num</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angles_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_angles_num</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;photometric_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photometric_type</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;units_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units_type</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">height</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;ballast_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ballast_factor</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;future_use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">future_use</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;input_watts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_watts</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v_angs</span><span class="p">)</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">h_angs</span><span class="p">)</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamp_cone_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamp_cone_type</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamp_h_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lamp_h_type</span><span class="p">)</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">candela_values</span><span class="p">)</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">candela_2d</span><span class="p">)</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;v_same&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_same</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_same&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h_same</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># normalize candela values to max = 1 or I0 = 1:</span>
    <span class="n">IES</span> <span class="o">=</span> <span class="n">_normalize_candela_2d</span><span class="p">(</span><span class="n">IES</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">)</span>

    <span class="c1"># complete lid to full theta[0-180] and phi [0-360]</span>
    <span class="n">IES</span> <span class="o">=</span> <span class="n">_complete_ies_lid</span><span class="p">(</span><span class="n">IES</span><span class="p">,</span> <span class="n">lamp_h_type</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamp_h_type&#39;</span><span class="p">])</span>
    
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;Iv0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="o">*</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lumens_per_lamp&#39;</span><span class="p">]</span> <span class="c1">#lid in cd/klm </span>
    <span class="k">return</span> <span class="n">IES</span>
    
<span class="k">def</span> <span class="nf">_complete_ies_lid</span><span class="p">(</span><span class="n">IES</span><span class="p">,</span> <span class="n">lamp_h_type</span> <span class="o">=</span> <span class="s1">&#39;TYPE90&#39;</span><span class="p">,</span> <span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert IES LID map with lamp_h_type symmetry to a &#39;full&#39; map with phi: [0,360] and theta: [0,180].</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># Create full theta (0-180) and phi (0-360) sets</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamp_h_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TYPE90&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">complete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">],</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">],</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">90</span><span class="p">,</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">,</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">270</span><span class="p">))</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamp_h_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TYPE180&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">complete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">],</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">))</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;lamp_h_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TYPE360&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">complete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">],</span><span class="mi">361</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">],</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">make_map</span><span class="p">:</span>
        <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;thetas&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span>
        <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;phis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phis</span>
        <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candela_2d</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;thetas&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span>
        <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;phis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span>
        <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
    
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span>
    <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IES</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">IES</span>
  

<span class="k">def</span> <span class="nf">read_ldt_lamp_data</span><span class="p">(</span><span class="n">datasource</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="s1">&#39;I0&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in LDT data.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :datasource:</span>
<span class="sd">            | Filename of LDT file or StringIO object or string with LID data.</span>
<span class="sd">        :multiplier:</span>
<span class="sd">            | 1.0, optional</span>
<span class="sd">            | Scaler for candela values.</span>
<span class="sd">        :verbosity:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | Display messages while reading file.</span>
<span class="sd">        :normalize:</span>
<span class="sd">            | &#39;I0&#39;, optional</span>
<span class="sd">            | If &#39;I0&#39;: normalize LID to intensity at (theta,phi) = (0,0)</span>
<span class="sd">            | If &#39;max&#39;: normalize to max = 1.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :LDT: dict with LDT data.</span>
<span class="sd">            |</span>
<span class="sd">            | dict_keys(</span>
<span class="sd">            | [&#39;datasource&#39;, &#39;version&#39;, &#39;manufacturer&#39;, &#39;Ityp&#39;,&#39;Isym&#39;,</span>
<span class="sd">            | &#39;Mc&#39;, &#39;Dc&#39;, &#39;Ng&#39;, &#39;name&#39;, Dg&#39;, &#39;cct/cri&#39;, &#39;tflux&#39;, &#39;lumens_per_lamp&#39;,</span>
<span class="sd">            | &#39;candela_mult&#39;, &#39;tilt&#39;, lamps_num&#39;,</span>
<span class="sd">            | &#39;cangles&#39;, &#39;tangles&#39;,&#39;candela_values&#39;, &#39;candela_2d&#39;,</span>
<span class="sd">            | &#39;intensity&#39;, &#39;theta&#39;, &#39;values&#39;, &#39;phi&#39;, &#39;map&#39;, &#39;Iv0&#39;]</span>
<span class="sd">            | )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">content</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">_read_file</span><span class="p">(</span><span class="n">datasource</span><span class="p">)</span>
    <span class="n">LDT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;datasource&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">}</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># with open(filename) as file:</span>
    <span class="n">content_list</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cangles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tangles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">candela_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># manufacturer</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;manufacturer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># type indicator: 1: point with symm. around vert. axis, 2: line luminaire, 3: point with other symm.</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ityp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;point source with symm. around vert. axis&#39;</span>
            <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ityp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;line luminaire&#39;</span>
            <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">3.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ityp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;point source with other symm.&#39;</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># symm. indicator</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Isym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;no symmetry&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Isym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;symmetry about the vertical axis&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Isym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;symmetry to plane C0-C180&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">3.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Isym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;symmetry to plane C90-C270&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mf">4.0</span><span class="p">:</span>
                <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Isym&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;symmetry to plane C0-C180 and to plane C90-C270&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># Number Mc of C-planes between 0 and 360 degrees </span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># Distance Dc between C-planes (Dc = 0 for non-equidistantly available C-planes)</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Dc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># Number Ng of luminous intensities in each C-plane</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ng&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># Distance Dg between luminous intensities per C-plane (Dg = 0 for non-equidistantly available luminous intensities in C-planes)</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Dg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span> <span class="c1"># luminaire name</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">23</span><span class="p">:</span> <span class="c1"># conversion factor</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;candela_mult&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">24</span><span class="p">:</span> <span class="c1"># Tilt angle</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;tilt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span> <span class="c1"># number of lamps</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;lamps_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">28</span><span class="p">:</span> <span class="c1"># total luminous flux</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;tflux&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;lumens_per_lamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;tflux&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">29</span><span class="p">:</span> <span class="c1"># cct/cri</span>
            <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;cct/cri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">42</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span> <span class="c1"># start of C-angles</span>
            <span class="n">cangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">42</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ng&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span> <span class="c1"># start of t-angles</span>
            <span class="n">tangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ng&#39;</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ng&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Mc&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ng&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span><span class="n">candela_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
         
    <span class="n">candela_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candela_values</span><span class="p">)</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;candela_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candela_values</span><span class="p">)</span>
    <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candela_values</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Ng&#39;</span><span class="p">])))</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cangles</span><span class="p">)[:</span><span class="n">candela_2d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tangles</span><span class="p">)</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">candela_2d</span><span class="p">)</span>

    <span class="c1"># normalize candela values to max = 1 or I0 = 1:</span>
    <span class="n">LDT</span> <span class="o">=</span> <span class="n">_normalize_candela_2d</span><span class="p">(</span><span class="n">LDT</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">)</span>

    <span class="c1"># complete lid to full theta[0-180] and phi [0-360]</span>
    <span class="n">LDT</span> <span class="o">=</span> <span class="n">_complete_ldt_lid</span><span class="p">(</span><span class="n">LDT</span><span class="p">,</span> <span class="n">Isym</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Isym&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;Iv0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="o">*</span><span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;tflux&#39;</span><span class="p">]</span> <span class="c1">#lid in cd/klm </span>
    <span class="k">return</span> <span class="n">LDT</span>

    
<span class="k">def</span> <span class="nf">_complete_ldt_lid</span><span class="p">(</span><span class="n">LDT</span><span class="p">,</span> <span class="n">Isym</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert LDT LID map with Isym symmetry to a &#39;full&#39; map with phi: [0,360] and theta: [0,180].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cangles</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span>
    <span class="n">tangles</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span>
    <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Isym</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">complete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="c1"># complete cangles:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">candela_2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">[:,(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">[:,(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">candela_2d_0C360</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">[:,:</span><span class="mi">1</span><span class="p">]))</span> 
        <span class="n">cangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cangles</span><span class="p">,</span> <span class="n">cangles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="mi">90</span><span class="p">,</span> <span class="n">cangles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">,</span> <span class="n">cangles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="mi">270</span><span class="p">))</span>
        <span class="c1"># complete  tangles:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">candela_2d_0C360</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">1</span><span class="p">:,:]))</span>
        <span class="n">tangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">tangles</span><span class="p">,</span> <span class="n">tangles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="mi">90</span><span class="p">))</span>
        <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">Isym</span> <span class="o">==</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">complete</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
        <span class="c1"># complete cangles:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">candela_2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">a</span><span class="p">[:,(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">[:,(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">candela_2d_0C360</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">[:,:</span><span class="mi">1</span><span class="p">]))</span> 
        <span class="n">cangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cangles</span><span class="p">,</span> <span class="o">-</span><span class="n">cangles</span><span class="p">[(</span><span class="n">cangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">))</span>
        <span class="n">cangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cangles</span><span class="p">,</span> <span class="o">-</span><span class="n">cangles</span><span class="p">[(</span><span class="n">cangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span><span class="p">))</span>
        <span class="n">cangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">cangles</span><span class="p">,</span><span class="n">cangles</span><span class="p">[:</span><span class="mi">1</span><span class="p">]))</span> 
        <span class="c1"># complete  tangles:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">candela_2d_0C360</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="mi">1</span><span class="p">:,:]))</span>
        <span class="n">tangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">tangles</span><span class="p">,</span> <span class="o">-</span><span class="n">tangles</span><span class="p">[(</span><span class="n">tangles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">180</span><span class="p">))</span>
        <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">b</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">######################</span><span class="se">\n</span><span class="s1">complete_ldt_lid(): Other &quot;Isym&quot; than &quot;4&quot;, not yet implemented (31/10/2018). Creating map dictionary filled with original uncompleted values!</span><span class="se">\n</span><span class="s1">######################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">make_map</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="n">make_map</span><span class="p">:</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;thetas&#39;</span><span class="p">:</span> <span class="n">tangles</span><span class="p">}</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;phis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cangles</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candela_2d</span><span class="o">.</span><span class="n">T</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;thetas&#39;</span><span class="p">:</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]}</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;phis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
        <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span>
    <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LDT</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">LDT</span>         

<span class="k">def</span> <span class="nf">_normalize_candela_2d</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="s1">&#39;I0&#39;</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    
    <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="c1"># normalize candela values to max = 1</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="n">candela_2d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">maxval</span>
    <span class="k">elif</span> <span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;I0&#39;</span><span class="p">:</span> <span class="c1"># normalize candela values to I0 = 1 </span>
        <span class="n">I0</span> <span class="o">=</span> <span class="n">candela_2d</span><span class="p">[</span><span class="n">LID</span><span class="p">[</span><span class="s1">&#39;h_angs&#39;</span><span class="p">]</span><span class="o">==</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;v_angs&#39;</span><span class="p">]</span><span class="o">==</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">I0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">normalize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">normalize</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported normalize option (valid string options are &#39;max&#39;, &#39;I0&#39;, &#39;none&#39;)&quot;</span><span class="p">)</span>
    <span class="n">candela_2d</span> <span class="o">=</span> <span class="n">candela_2d</span><span class="o">/</span><span class="n">norm</span>
    <span class="n">candela_mult</span> <span class="o">=</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;candela_mult&#39;</span><span class="p">]</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">candela_mult</span>
    <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;candela_2d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candela_2d</span>
    <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span>
    <span class="k">return</span> <span class="n">LID</span>


<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># Texture creation and saving</span>
<span class="c1">#------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">_spher2cart</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert spherical to cartesian coordinates.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :theta:</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | Angle with positive z-axis.</span>
<span class="sd">        :phi:</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | Angle around positive z-axis starting from x-axis.</span>
<span class="sd">        :r:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | radius</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :x, y, z:</span>
<span class="sd">            | tuple of floats, ints or ndarrays</span>
<span class="sd">            | Cartesian coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y</span><span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">z</span><span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>

<span class="k">def</span> <span class="nf">_cart2spher</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert cartesian to spherical coordinates.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :x, y, z:</span>
<span class="sd">            | tuple of floats, ints or ndarrays</span>
<span class="sd">            | Cartesian coordinates</span>
<span class="sd">        :theta:</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | Angle with positive z-axis.</span>
<span class="sd">        :phi:</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | Angle around positive z-axis starting from x-axis.</span>
<span class="sd">        :r:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | radius</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :theta:</span>
<span class="sd">            | ndarray of angles with positive z-axis.</span>
<span class="sd">        :phi:</span>
<span class="sd">            | ndarray of angles around positive z-axis starting from x-axis.</span>
<span class="sd">        :r:</span>
<span class="sd">            | ndarray of radii</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="n">r</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">phi</span><span class="p">[</span><span class="n">phi</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">phi</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">r</span>

<div class="viewcode-block" id="get_uv_texture"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.iolidfiles.get_uv_texture">[docs]</a><span class="k">def</span> <span class="nf">get_uv_texture</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">input_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span><span class="s1">&#39;array&#39;</span><span class="p">),</span>\
                   <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">theta_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">angle_res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">close_phi</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>\
                   <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">show</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;values_map&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a uv-texture map.</span>
<span class="sd">    | with specified angular resolution () and with positive z-axis as normal.</span>
<span class="sd">    |   u corresponds to phi [0 - 360]</span>
<span class="sd">    |   v corresponds to theta [0 - 180], (or [-90 - 90])</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :theta:</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | Angle with positive z-axis.</span>
<span class="sd">            | Values corresponding to 0 and 180 must be specified!</span>
<span class="sd">        :phi:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | Angle around positive z-axis starting from x-axis.</span>
<span class="sd">            | If not None: values corresponding to 0 and 360 must be specified!</span>
<span class="sd">        :values:</span>
<span class="sd">            | None</span>
<span class="sd">            | ndarray or mesh of values at (theta, phi) locations. </span>
<span class="sd">        :input_types:</span>
<span class="sd">            | (&#39;array&#39;,&#39;array&#39;), optional</span>
<span class="sd">            | Specification of type of input of (angles,values)</span>
<span class="sd">        :method:</span>
<span class="sd">            | &#39;linear&#39;, optional</span>
<span class="sd">            | Interpolation method.</span>
<span class="sd">            | (supported scipy.interpolate.griddata methods: </span>
<span class="sd">            |  &#39;nearest&#39;, &#39;linear&#39;, &#39;cubic&#39;)</span>
<span class="sd">        :theta_min:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | If 0: [0, 180]; If -90: theta range = [-90,90]</span>
<span class="sd">        :close_phi:</span>
<span class="sd">            | False, optional</span>
<span class="sd">            | Make phi angles array closed (full circle).</span>
<span class="sd">        :angle_res:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Resolution in degrees.</span>
<span class="sd">        :deg: </span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Type of angle input (True: degrees, False: radians).</span>
<span class="sd">        :r:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Float, int or ndarray</span>
<span class="sd">            | radius</span>
<span class="sd">        :show:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Plot results.</span>
<span class="sd">        :out:</span>
<span class="sd">            | &#39;values_map&#39;, optional</span>
<span class="sd">            | Specifies output: &quot;return eval(out)&quot;</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns: as specified by :out:.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Create uv base map:</span>
    <span class="c1">#--------------------</span>
    
    <span class="c1"># set up uv_map angles:</span>
    <span class="n">theta_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span> <span class="o">+</span> <span class="n">angle_res</span><span class="p">,</span> <span class="n">angle_res</span><span class="p">)</span>
    <span class="n">phi_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span> <span class="o">+</span> <span class="p">(</span><span class="n">close_phi</span><span class="p">)</span><span class="o">*</span><span class="n">angle_res</span><span class="p">,</span> <span class="n">angle_res</span><span class="p">)</span>
    
    <span class="c1"># create angle base mesh:</span>
    <span class="n">thetam_map</span><span class="p">,</span> <span class="n">phim_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">theta_map</span><span class="p">,</span> <span class="n">phi_map</span><span class="p">)</span>
    
    <span class="c1"># convert input angles to uv coordinates:</span>
    <span class="n">um_map</span><span class="p">,</span> <span class="n">vm_map</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">phim_map</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> <span class="n">thetam_map</span><span class="o">/</span><span class="mi">180</span>
    
    
    <span class="c1"># Create uv map from input:</span>
    <span class="c1">#-------------------------</span>
    <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">phi</span><span class="o">==</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span> <span class="n">phi</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># if phi = 0: assume rotational symmetry</span>
        
    <span class="c1"># When only (theta,values) data is given--&gt; assume rotational symmetry:</span>
    <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi_map</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">360</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">angle_res</span><span class="p">)),</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># assume rotational symmetry, values must be array!</span>
        <span class="n">input_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;mesh&#39;</span><span class="p">)</span> 

    <span class="c1"># convert radians to degrees:</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">input_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">input_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">):</span>
        <span class="c1"># create angle input mesh:</span>
        <span class="n">thetam_in</span><span class="p">,</span> <span class="n">phim_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">input_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">input_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">):</span>
        <span class="n">thetam_in</span><span class="p">,</span> <span class="n">phim_in</span> <span class="o">=</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="c1"># work with array data</span>
    
    <span class="c1"># convert input angles to uv coordinates:</span>
    <span class="n">um_in</span><span class="p">,</span> <span class="n">vm_in</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">phim_in</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> <span class="n">thetam_in</span><span class="o">/</span><span class="mi">180</span>
    
    <span class="c1"># Interpolate values for uv_in to values for uv_map:</span>
    <span class="n">values_map</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">um_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">vm_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="n">um_map</span><span class="p">,</span><span class="n">vm_map</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">xm_map</span><span class="p">,</span> <span class="n">ym_map</span><span class="p">,</span> <span class="n">zm_map</span> <span class="o">=</span> <span class="n">_spher2cart</span><span class="p">(</span><span class="n">thetam_map</span><span class="p">,</span><span class="n">phim_map</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">xm_in</span><span class="p">,</span> <span class="n">ym_in</span><span class="p">,</span> <span class="n">zm_in</span> <span class="o">=</span> <span class="n">_spher2cart</span><span class="p">(</span><span class="n">thetam_in</span><span class="p">,</span><span class="n">phim_in</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xm_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ym_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">zm_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Output map&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xm_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ym_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">zm_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Input map&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Cartesian map coordinates&#39;</span><span class="p">)</span>
        
  
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">um_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">vm_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">values_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Output&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">um_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">vm_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="s1">&#39;r.&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Input&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;uv texture map&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">theta_min</span> <span class="o">==</span> <span class="o">-</span><span class="mi">90</span><span class="p">:</span>
        <span class="n">values_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">values_map</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">theta_min</span><span class="p">)</span><span class="o">/</span><span class="n">angle_res</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">theta_map</span> <span class="o">=</span> <span class="n">theta_map</span> <span class="o">+</span> <span class="n">theta_min</span>
        
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="save_texture"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.iolidfiles.save_texture">[docs]</a><span class="k">def</span> <span class="nf">save_texture</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">tex</span><span class="p">,</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">transpose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save 16 bit grayscale PNG image of uv-texture.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :filename:</span>
<span class="sd">            | Filename of output image.</span>
<span class="sd">        :tex: </span>
<span class="sd">            | ndarray float uv-texture.</span>
<span class="sd">        :transpose:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | If True: transpose tex (u,v) to set u as columns and v as rows </span>
<span class="sd">            | in texture image.</span>
<span class="sd">            </span>
<span class="sd">    Returns:</span>
<span class="sd">        :None:</span>
<span class="sd">            </span>
<span class="sd">    Note:</span>
<span class="sd">        | Texture is rescaled to max = 1 and saved as uint16.</span>
<span class="sd">        | --&gt; Before using uv_map: rescale back to set &#39;normal&#39; to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#im = exposure.rescale_intensity(tex, out_range=&#39;float&#39;)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">2</span><span class="o">**</span><span class="n">bits</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">tex</span><span class="o">/</span><span class="n">tex</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">))</span> <span class="c1">#</span>
    <span class="c1">#im = img_as_uint(im)</span>
    <span class="k">if</span> <span class="n">transpose</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">T</span>
    <span class="n">imageio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">im</span><span class="p">)</span></div>
  
<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># Make plot of LID</span>
<span class="c1">#------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">get_cart_lid_map</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span><span class="n">grid_interp_method</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">theta_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">angle_res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,):</span>
    <span class="n">values_map</span><span class="p">,</span><span class="n">phim_map</span><span class="p">,</span><span class="n">thetam_map</span> <span class="o">=</span> <span class="n">get_uv_texture</span><span class="p">(</span><span class="n">theta</span> <span class="o">=</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;thetas&#39;</span><span class="p">],</span> 
                                                    <span class="n">phi</span> <span class="o">=</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;phis&#39;</span><span class="p">],</span> 
                                                    <span class="n">values</span> <span class="o">=</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">],</span> 
                                                    <span class="n">input_types</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span><span class="s1">&#39;mesh&#39;</span><span class="p">),</span> 
                                                    <span class="n">method</span> <span class="o">=</span> <span class="n">grid_interp_method</span><span class="p">,</span> 
                                                    <span class="n">theta_min</span> <span class="o">=</span> <span class="n">theta_min</span><span class="p">,</span> 
                                                    <span class="n">angle_res</span> <span class="o">=</span> <span class="n">angle_res</span><span class="p">,</span> 
                                                    <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                                    <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                                                    <span class="n">show</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">out</span><span class="o">=</span><span class="s1">&#39;values_map,phim_map,thetam_map&#39;</span><span class="p">)</span>
    <span class="n">values_map</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">values_map</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># get cartesian coordinates:</span>
    <span class="c1">#r = values_map/values_map.max() if normalize_intensity_to_max else values_map</span>
    <span class="n">xm_map</span><span class="p">,</span><span class="n">ym_map</span><span class="p">,</span><span class="n">zm_map</span><span class="o">=</span><span class="n">_spher2cart</span><span class="p">(</span><span class="n">thetam_map</span><span class="p">,</span><span class="n">phim_map</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">values_map</span><span class="p">,</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xm_map</span><span class="p">,</span><span class="n">ym_map</span><span class="p">,</span><span class="n">zm_map</span><span class="p">,</span><span class="n">phim_map</span><span class="p">,</span><span class="n">thetam_map</span><span class="p">,</span><span class="n">values_map</span>

<div class="viewcode-block" id="draw_lid"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.iolidfiles.draw_lid">[docs]</a><span class="k">def</span> <span class="nf">draw_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">grid_interp_method</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">theta_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">angle_res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
             <span class="n">ax</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">polar_plot_Cx_planes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">],</span> 
             <span class="n">use_scatter_plot</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_colorbar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">legend_on</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
             <span class="n">plot_luminaire_position</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;ax&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plottingkwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw the light intensity distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :LID:</span>
<span class="sd">            | dict with IES or LDT file data. </span>
<span class="sd">            | (obtained with iolidfiles.read_lamp_data())</span>
<span class="sd">        :grid_interp_method:</span>
<span class="sd">            | &#39;linear&#39;, optional</span>
<span class="sd">            | Interpolation method for (theta,phi)-grid of normalized luminous intensity values.</span>
<span class="sd">            | (supported scipy.interpolate.griddata methods: </span>
<span class="sd">            |  &#39;nearest&#39;, &#39;linear&#39;, &#39;cubic&#39;)</span>
<span class="sd">        :theta_min:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | If 0: [0, 180]; If -90: theta range = [-90,90]</span>
<span class="sd">        :angle_res:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Resolution in degrees.</span>
<span class="sd">        :ax:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | If None: create new 3D-axes for plotting.</span>
<span class="sd">        :projection:</span>
<span class="sd">            | &#39;2d&#39;, optional</span>
<span class="sd">            | If &#39;3d&#39; make 3 plot</span>
<span class="sd">            | If &#39;2d&#39;: make polar plot(s). [not yet implemented (25/03/2021)]</span>
<span class="sd">        :polar_plot_Cx_planes:</span>
<span class="sd">            | [0,90], optional</span>
<span class="sd">            | Plot (Cx)-(Cx+180) planes; eg. [0,90] will plot C0-C180 and C90-C270 planes in 2D polar plot.</span>
<span class="sd">        :use_scatter_plot:</span>
<span class="sd">            | False, optional</span>
<span class="sd">            | If True: use plt.scatter for plotting intensity values in 3D plot.</span>
<span class="sd">            | If False: use plt.plot_surface for plotting in 3D plot.</span>
<span class="sd">        :plot_colorbar:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Plot colorbar representing the normalized luminous intensity values in the LID 3D plot.</span>
<span class="sd">        :legend_on:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | If True: plot legend on polar plot (no legend for 3D plot!).</span>
<span class="sd">        :plot_luminaire_position:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Plot the position of the luminaire (0,0,0) in the 3D graph as a red diamond.</span>
<span class="sd">        :out:</span>
<span class="sd">            | &#39;ax&#39;, optional</span>
<span class="sd">            | string with variable to return</span>
<span class="sd">            | default: ax handle to plot.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns:</span>
<span class="sd">            | Whatever requested as determined by the string in :out:</span>
<span class="sd">                </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">xm_map</span><span class="p">,</span><span class="n">ym_map</span><span class="p">,</span><span class="n">zm_map</span><span class="p">,</span><span class="n">phim_map</span><span class="p">,</span><span class="n">thetam_map</span><span class="p">,</span>
    <span class="n">values_map</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_cart_lid_map</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span>
                                   <span class="n">grid_interp_method</span> <span class="o">=</span> <span class="n">grid_interp_method</span><span class="p">,</span> 
                                   <span class="n">theta_min</span> <span class="o">=</span> <span class="n">theta_min</span><span class="p">,</span> 
                                   <span class="n">angle_res</span> <span class="o">=</span> <span class="n">angle_res</span><span class="p">)</span>   
    
    <span class="c1"># make plot:</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;3d&#39;</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">polar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">projection</span>  <span class="o">==</span> <span class="s1">&#39;3d&#39;</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_make_3D_lid_plot</span><span class="p">(</span><span class="n">xm_map</span><span class="p">,</span> <span class="n">ym_map</span><span class="p">,</span> <span class="n">zm_map</span><span class="p">,</span> <span class="n">values_map</span><span class="p">,</span> <span class="n">plot_luminaire_position</span><span class="p">,</span>
                               <span class="n">ax</span><span class="p">,</span> <span class="n">use_scatter_plot</span><span class="p">,</span> <span class="n">plot_colorbar</span><span class="p">,</span><span class="o">**</span><span class="n">plottingkwargs</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="p">,</span><span class="n">plot_op_half</span> <span class="o">=</span> <span class="n">_make_2D_lid_plot_polar</span><span class="p">(</span><span class="n">phim_map</span><span class="p">,</span> <span class="n">thetam_map</span><span class="p">,</span> <span class="n">values_map</span><span class="p">,</span> 
                               <span class="n">ax</span><span class="p">,</span> <span class="n">polar_plot_Cx_planes</span> <span class="o">=</span> <span class="n">polar_plot_Cx_planes</span><span class="p">,</span> <span class="o">**</span><span class="n">plottingkwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot_op_half</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_thetamin</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_thetamax</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">legend_on</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">projection</span> <span class="o">==</span> <span class="s1">&#39;2d&#39;</span><span class="p">):</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;best&#39;</span><span class="p">)</span><span class="c1">#bbox_to_anchor=(1.07, 0.8))</span>
    
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_make_3D_lid_plot</span><span class="p">(</span><span class="n">xm_map</span><span class="p">,</span> <span class="n">ym_map</span><span class="p">,</span> <span class="n">zm_map</span><span class="p">,</span> <span class="n">values_map</span><span class="p">,</span> <span class="n">plot_luminaire_position</span><span class="p">,</span>
                      <span class="n">ax</span><span class="p">,</span> <span class="n">use_scatter_plot</span><span class="p">,</span> <span class="n">plot_colorbar</span><span class="p">,</span><span class="o">**</span><span class="n">plottingkwargs</span><span class="p">):</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">values_map</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">use_scatter_plot</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xm_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">ym_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="o">-</span><span class="n">zm_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
                   <span class="n">c</span> <span class="o">=</span> <span class="n">values_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Normalized luminous intensity&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plottingkwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xm_map</span><span class="p">,</span><span class="n">ym_map</span><span class="p">,</span><span class="o">-</span><span class="n">zm_map</span><span class="p">,</span> <span class="n">facecolors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">)),</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Normalized luminous intensity&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plottingkwargs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot_colorbar</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_array</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Normalized luminous intensity ($I_0 = 1$)&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot_luminaire_position</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Luminaire equivalent position&#39;</span><span class="p">)</span>
    
    <span class="c1"># calculate aspect ratio:</span>
    <span class="n">xyzlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim3d</span><span class="p">(),</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim3d</span><span class="p">(),</span><span class="n">ax</span><span class="o">.</span><span class="n">get_zlim3d</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">xyzlim</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">/</span><span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_box_aspect</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">_make_2D_lid_plot_polar</span><span class="p">(</span><span class="n">phim_map</span><span class="p">,</span> <span class="n">thetam_map</span><span class="p">,</span> <span class="n">values_map</span><span class="p">,</span>  
                      <span class="n">ax</span><span class="p">,</span> <span class="n">polar_plot_Cx_planes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="o">**</span><span class="n">plottingkwargs</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">get_tr</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">phim_map</span> <span class="o">==</span> <span class="n">phi</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">phim_map</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">180</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">phim_map</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">))</span> 
        <span class="n">t</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">thetam_map</span><span class="p">[</span><span class="n">pp</span><span class="p">])</span><span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">values_map</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">r</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">linestyles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span>
    <span class="n">t_top</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># for plotting top  half of polar plot or not</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polar_plot_Cx_planes</span><span class="p">):</span>
        <span class="n">phio</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="mi">180</span> <span class="c1"># phi on opposite side</span>
        
        <span class="n">t</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_tr</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="n">t_top</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;C</span><span class="si">{:1.0f}</span><span class="s1">-C</span><span class="si">{:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="n">phio</span><span class="p">),</span><span class="o">**</span><span class="n">plottingkwargs</span><span class="p">)</span>
          
        <span class="n">t</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_tr</span><span class="p">(</span><span class="n">phio</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> <span class="n">t_top</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="n">linestyles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">**</span><span class="n">plottingkwargs</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">t_top</span>


<span class="c1">#------------------------------------------------------------------------------</span>
<span class="c1"># Render LID image</span>
<span class="c1">#------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span><span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

<span class="k">def</span> <span class="nf">_rotationmatrix_3d</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">omcost</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">sint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cost</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">omcost</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">omcost</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">sint</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">omcost</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">sint</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">omcost</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">sint</span><span class="p">,</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">omcost</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">omcost</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sint</span><span class="p">],</span>
                      <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">omcost</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">sint</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">omcost</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sint</span><span class="p">,</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">omcost</span><span class="p">]])</span>    
    <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))),</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))))</span>
        <span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">R</span>

<span class="c1"># def cross_to_angle(a,b, u = None):</span>
<span class="c1">#     crossab = np.cross(a,b) if u is None else u</span>
<span class="c1">#     return np.arcsin(_norm(crossab)/(_norm(a)*_norm(b)))</span>

<span class="k">def</span> <span class="nf">_dot_to_angle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">_norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> 

<span class="k">def</span> <span class="nf">_perpendicular_vector</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

<span class="k">def</span> <span class="nf">_get_rotation_matrix</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    
    <span class="c1"># calculate angle between normal n1 and normal n2:</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">_dot_to_angle</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
    
    <span class="c1"># calculate rotation axis to rotate normal n1 to desired normal n2:</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">_norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">_perpendicular_vector</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">/</span><span class="n">_norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>

    <span class="c1"># get rotation matrix</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">_rotationmatrix_3d</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">u</span>

<span class="k">def</span> <span class="nf">_create_plane</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># create plane with width w and height h and normal along negative y-axis:</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">w</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">n_</span> <span class="o">=</span> <span class="n">n_</span><span class="o">/</span><span class="n">_norm</span><span class="p">(</span><span class="n">n_</span><span class="p">)</span>

    <span class="c1"># get raotation matrix (and angle theta around axis u)</span>
    <span class="c1"># to go from constructed normal n_ to desired normal n:</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">_get_rotation_matrix</span><span class="p">(</span><span class="n">n_</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

    <span class="c1"># create grid:</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">res</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">grid</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">center</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>
        
    <span class="c1"># rotate plane and recalculate n_ (should match n, if not then n_ &amp; n colinear):</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">corners</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
    <span class="n">s1</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">n_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span>
    <span class="n">n_</span> <span class="o">=</span> <span class="n">n_</span><span class="o">/</span><span class="n">_norm</span><span class="p">(</span><span class="n">n_</span><span class="p">)</span>

    <span class="n">corners</span> <span class="o">=</span> <span class="n">corners</span> <span class="o">+</span> <span class="n">center</span>

    <span class="k">return</span> <span class="n">corners</span><span class="p">,</span> <span class="n">n_</span><span class="p">,</span> <span class="n">grid</span>

<span class="c1">#corners,n_, grid = _create_plane(w = 20, h = 10, center = np.array([0,1,1]), n = [-1,0,0], res = 100)</span>

                         
<span class="k">def</span> <span class="nf">_create_sensor_plane</span><span class="p">(</span><span class="n">fov</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">Fd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">200</span><span class="p">):</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">fov</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Fd</span><span class="o">*</span><span class="mi">2</span>
    
    <span class="n">center</span> <span class="o">=</span> <span class="n">position</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">Fd</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># center of sensor plane</span>
    <span class="n">corners</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pixels</span> <span class="o">=</span> <span class="n">_create_plane</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span><span class="o">*</span><span class="n">Fd</span> <span class="o">+</span> <span class="n">center</span> <span class="c1"># new position of sensor focal point</span>

    <span class="n">drays</span> <span class="o">=</span> <span class="n">pixels</span> <span class="o">-</span> <span class="n">position</span>
    <span class="n">drays</span> <span class="o">=</span> <span class="n">drays</span><span class="o">/</span><span class="n">_norm</span><span class="p">(</span><span class="n">drays</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">corners</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">drays</span>

<span class="k">def</span> <span class="nf">_get_line_plane_intersection</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">dl</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">corners</span><span class="p">):</span>
    <span class="c1"># check if not parallel:</span>
    <span class="n">intersects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="c1"># get u of intersection point along line segment l(u) = l0 + u*dl:</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">intersects</span><span class="p">)</span>
    <span class="n">u</span><span class="p">[</span><span class="n">intersects</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">p0</span><span class="o">-</span><span class="n">l0</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl</span><span class="p">[</span><span class="n">intersects</span><span class="p">],</span><span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># intersection points:</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">l0</span> <span class="o">+</span> <span class="n">u</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="n">dl</span>
    
    <span class="c1"># check if inside rectangle:</span>
    <span class="c1"># a. get length of sides of rectangle:</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># b. get projection&#39;s q1 and q2 of vector(corners[0],l) along s1 and s2:</span>
    <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s1</span><span class="p">)</span>
    <span class="n">q2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">s2</span><span class="p">)</span>
    <span class="c1"># c. check if projections are smaller than sizes and larger than zero:</span>
    <span class="n">in_rectangle</span> <span class="o">=</span> <span class="p">((</span><span class="n">q1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">q1</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">q2</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">q2</span><span class="o">&lt;=</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="n">s2</span><span class="p">)))</span>
    <span class="c1"># d. fill rays which miss rectangles with nan&#39;s:</span>
    <span class="n">l</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">in_rectangle</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">return</span> <span class="n">l</span><span class="p">,</span> <span class="n">u</span>
    
<span class="k">def</span> <span class="nf">_plot_plane_edges</span><span class="p">(</span><span class="n">corners</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">):</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">corners</span><span class="p">,</span><span class="n">corners</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">corners</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])),</span>  
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">corners</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])),</span><span class="n">color</span> <span class="o">=</span> <span class="n">color</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="n">marker</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="k">def</span> <span class="nf">_read_luminous_intensity</span><span class="p">(</span><span class="n">thetas</span><span class="p">,</span> <span class="n">phis</span><span class="p">,</span> <span class="n">LID</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">):</span>
    <span class="c1"># Interpolate values for uv_in to values for uv_map:</span>
    <span class="n">thetam_in</span><span class="p">,</span> <span class="n">phim_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">LID</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;thetas&#39;</span><span class="p">],</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;phis&#39;</span><span class="p">])</span>
    <span class="n">Iv</span> <span class="o">=</span> <span class="n">LID</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">][</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="n">Ivs</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phim_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">thetam_in</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Iv</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="n">phis</span><span class="p">,</span><span class="n">thetas</span><span class="p">),</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ivs</span>

<span class="k">def</span> <span class="nf">_get_luminaire_illuminance_at_plane</span><span class="p">(</span><span class="n">plum</span><span class="p">,</span> <span class="n">nlum</span><span class="p">,</span> <span class="n">pplane</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">xyzm_maps</span><span class="p">):</span>
    <span class="n">u0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pplane</span> <span class="o">-</span> <span class="n">plum</span><span class="p">)</span> <span class="c1"># vectors from plane points to lum</span>
    <span class="c1"># d = _norm(u) # distances between luminaire and points</span>
    
    <span class="c1"># # rotate lid of luminaire:</span>
    <span class="n">nz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">nrot</span> <span class="o">=</span> <span class="n">_get_rotation_matrix</span><span class="p">(</span><span class="n">nz</span><span class="p">,</span><span class="n">nlum</span><span class="p">)</span>
    <span class="n">Ri</span><span class="p">,</span> <span class="n">thetai</span><span class="p">,</span> <span class="n">nroti</span> <span class="o">=</span> <span class="n">_get_rotation_matrix</span><span class="p">(</span><span class="n">nlum</span><span class="p">,</span><span class="n">nz</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">xyzm_maps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xyzm_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xyzm_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xyzm_maps</span><span class="p">))])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">xyzm_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">xyzm_maps</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nlum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">nz</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="c1">#update LID-normal (pointing away from luminaire)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ri</span><span class="p">,</span><span class="n">u0</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">if</span> <span class="n">xyzm_maps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xyzm_maps</span> <span class="o">=</span> <span class="n">xyzm_maps</span> <span class="o">+</span> <span class="n">plum</span>
    
    <span class="c1"># get theta, phi, r relative to source orientation for use with LID:</span>
    <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">_cart2spher</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">u</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">u</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">deg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    
   
    <span class="c1"># luminous intensity Iv along direction (theta,phi)</span>
    <span class="n">Iv</span> <span class="o">=</span> <span class="n">_read_luminous_intensity</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    
    <span class="c1"># illuminance at point pplane:</span>
    <span class="n">Ev</span> <span class="o">=</span> <span class="n">Iv</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span><span class="o">/</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">Ev</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">nlum</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">xyzm_maps</span>

<span class="k">def</span> <span class="nf">_get_plane_luminance</span><span class="p">(</span><span class="n">plum</span><span class="p">,</span> <span class="n">nlum</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">pplane</span><span class="p">,</span> <span class="n">nplane</span><span class="p">,</span> <span class="n">psensor</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">xyzm_maps</span><span class="p">):</span>
    <span class="n">Ev</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">nlum</span><span class="p">,</span> <span class="n">dist_source</span><span class="p">,</span> <span class="n">xyzm_maps</span> <span class="o">=</span> <span class="n">_get_luminaire_illuminance_at_plane</span><span class="p">(</span><span class="n">plum</span><span class="p">,</span> <span class="n">nlum</span><span class="p">,</span> <span class="n">pplane</span><span class="p">,</span> <span class="n">lid</span><span class="p">,</span> <span class="n">xyzm_maps</span><span class="p">)</span> 
    
    <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span> <span class="c1"># check whether rays are pointing in opposite direction as surface normal of plane</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">/</span><span class="n">_norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">reflect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">nplane</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Ev</span><span class="p">[</span><span class="n">reflect</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># when normal is not pointing toward incident rays--&gt; no reflection (black backside of plane)</span>
    
    <span class="n">reflect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pplane</span> <span class="o">-</span> <span class="n">psensor</span><span class="p">,</span><span class="n">nplane</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="kc">None</span><span class="p">])[:,</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># plane surface normal must also point towards sensor</span>
    <span class="n">Ev</span><span class="p">[</span><span class="n">reflect</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="k">if</span> <span class="n">xyzm_maps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Ev</span><span class="o">*</span><span class="n">rho</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nlum</span><span class="p">,</span> <span class="n">dist_source</span><span class="p">,</span> <span class="n">xyzm_maps</span> <span class="c1"># assume Lambertian reflector</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Ev</span><span class="o">*</span><span class="n">rho</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">nlum</span><span class="p">,</span> <span class="n">dist_source</span><span class="p">,</span> <span class="n">xyzm_maps</span><span class="o">.</span><span class="n">T</span> <span class="c1"># assume Lambertian reflector</span>
        
<span class="c1"># def map_3D_to_2D(pplane,Lv, fov = (90,90), Fd = 1, res = 100, method = &#39;linear&#39;):</span>
<span class="c1">#     fov = np.array(fov)</span>
<span class="c1">#     size = np.deg2rad(fov/2)*Fd*2</span>
<span class="c1">#     w, h = size/2</span>
<span class="c1">#     corners = np.array([[-w/2,h/2],</span>
<span class="c1">#                         [-w/2,-h/2],</span>
<span class="c1">#                         [w/2,-h/2],</span>
<span class="c1">#                         [w/2,h/2]])</span>
<span class="c1">#     x = np.linspace(corners[0,0],corners[2,0], res)</span>
<span class="c1">#     y = np.linspace(corners[2,1],corners[0,1], res)</span>
<span class="c1">#     xg, yg = np.meshgrid(x,y)</span>
<span class="c1">#     Lv2D = interp.griddata(pplane,Lv, (x,y), method = method)</span>
<span class="c1">#     return Lv2D</span>


<div class="viewcode-block" id="render_lid"><a class="viewcode-back" href="../../../../toolboxes.html#luxpy.toolboxes.iolidfiles.render_lid">[docs]</a><span class="k">def</span> <span class="nf">render_lid</span><span class="p">(</span><span class="n">LID</span> <span class="o">=</span> <span class="s1">&#39;./data/luxpy_test_lid_file.ies&#39;</span><span class="p">,</span> 
               <span class="n">sensor_resolution</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">sensor_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">],</span> <span class="n">sensor_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">],</span> <span class="n">fov</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">Fd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
               <span class="n">luminaire_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.3</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">luminaire_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
               <span class="n">wall_center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">wall_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">wall_width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wall_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wall_rho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
               <span class="n">floor_center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">floor_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">floor_width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">floor_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">floor_rho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
               <span class="n">grid_interp_method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">angle_res</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">theta_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
               <span class="n">ax3D</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ax2D</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">join_axes</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">legend_on</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">plot_luminaire_position</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_lumiaire_rays</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_luminaire_lid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">plot_sensor_position</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_sensor_pixels</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_sensor_rays</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
               <span class="n">plot_wall_edges</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_wall_luminance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_wall_intersections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">plot_floor_edges</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_floor_luminance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_floor_intersections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Lv2D&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a light intensity distribution.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        :LID:</span>
<span class="sd">            | dict with IES or LDT file data or string with path/filename;</span>
<span class="sd">            | or String or StringIO object with IES or LDT data.</span>
<span class="sd">            | (dict should be obtained with iolidfiles.read_lamp_data())</span>
<span class="sd">        :sensor_resolution:</span>
<span class="sd">            | 100, optional</span>
<span class="sd">            | Number of sensor &#39;pixels&#39; along each dimension.</span>
<span class="sd">        :sensor_position:</span>
<span class="sd">            | [0,-1,0.8], optional</span>
<span class="sd">            | x,y,z position of the sensor &#39;focal&#39; point (is located Fd meters behind actual sensor plane)</span>
<span class="sd">        :sensor_n:</span>
<span class="sd">            | [0,1,-0.2], optional</span>
<span class="sd">            | Sensor plane surface normal</span>
<span class="sd">        :fov:</span>
<span class="sd">            | (90,90), optional</span>
<span class="sd">            | Field of view of sensor image in degrees.</span>
<span class="sd">        :Fd:</span>
<span class="sd">            | 2, optional</span>
<span class="sd">            | &#39;Focal&#39; distance in meter. Sensor center is located Fd meter away from</span>
<span class="sd">            | :sensor_position:</span>
<span class="sd">        :luminaire_position:</span>
<span class="sd">            | [0,1.3,2], optional</span>
<span class="sd">            | x,y,z position of the photometric equivalent point source</span>
<span class="sd">        :luminaire_n:</span>
<span class="sd">            | [0,0,-1], optional</span>
<span class="sd">            | Orientation of lumaire LID (default points downward along z-axis away from source)</span>
<span class="sd">        :wall_center:</span>
<span class="sd">            | [0,2,1], optiona</span>
<span class="sd">            | x,y,z position of the back wall</span>
<span class="sd">        :wall_n:</span>
<span class="sd">            | [0,-1,0], optional</span>
<span class="sd">            | surface normal of wall</span>
<span class="sd">        :wall_width:</span>
<span class="sd">            | 4, optional</span>
<span class="sd">            | width of wall (m)</span>
<span class="sd">        :wall_height:</span>
<span class="sd">            | 2, optional</span>
<span class="sd">            | height of wall (m)</span>
<span class="sd">        :wall_rho:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Diffuse (Lambertian) reflectance of wall.</span>
<span class="sd">        :floor_center:</span>
<span class="sd">            | [0,1,0], optiona</span>
<span class="sd">            | x,y,z position of the floor</span>
<span class="sd">        :floor_n:</span>
<span class="sd">            | [0,0,1], optional</span>
<span class="sd">            | surface normal of floor</span>
<span class="sd">        :floor_width:</span>
<span class="sd">            | 4, optional</span>
<span class="sd">            | width of floor (m)</span>
<span class="sd">        :floor_height:</span>
<span class="sd">            | 2, optional</span>
<span class="sd">            | height of floor (m)</span>
<span class="sd">        :floor_rho:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Diffuse (Lambertian) reflectance of floor.</span>
<span class="sd">        :grid_interp_method:</span>
<span class="sd">            | &#39;linear&#39;, optional</span>
<span class="sd">            | Interpolation method for (theta,phi)-grid of normalized luminous intensity values.</span>
<span class="sd">            | (supported scipy.interpolate.griddata methods: </span>
<span class="sd">            |  &#39;nearest&#39;, &#39;linear&#39;, &#39;cubic&#39;)</span>
<span class="sd">        :theta_min:</span>
<span class="sd">            | 0, optional</span>
<span class="sd">            | If 0: [0, 180]; If -90: theta range = [-90,90]</span>
<span class="sd">            | Only used when generating a plot of the LID in the 3D graphs.</span>
<span class="sd">        :angle_res:</span>
<span class="sd">            | 1, optional</span>
<span class="sd">            | Angle resolution in degrees of LID sampling.</span>
<span class="sd">            | Only used when generating a plot of the LID in the 3D graphs.</span>
<span class="sd">        :ax3D,ax2D:</span>
<span class="sd">            | None, optional</span>
<span class="sd">            | If None: create new 3D- or 2D- axes for plotting.</span>
<span class="sd">            | If join_axes == True: try and combine two axes on same figure.</span>
<span class="sd">            | If False: don&#39;t plot..</span>
<span class="sd">        :legend_on:</span>
<span class="sd">            | False, optional</span>
<span class="sd">            | plot legend.</span>
<span class="sd">        :plot_luminaire_position:</span>
<span class="sd">            | True, optional</span>
<span class="sd">            | Plot the position of the luminaire (0,0,0) in the graph as a red diamond.</span>
<span class="sd">        :plot_X_...:</span>
<span class="sd">            | VArious options to customize plotting. Mainly allows for plotting of</span>
<span class="sd">            | additional info such as plane-ray intersection points, sensor pixels,</span>
<span class="sd">            | sensor-to-plane rays, plane-to-luminaire rays, 3D plot of LID, etc.</span>
<span class="sd">        :out:</span>
<span class="sd">            | &#39;Lv2D&#39;, optional</span>
<span class="sd">            | string with variable to return</span>
<span class="sd">            | default: variable storing an grayscale image of the rendered LID.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        :returns:</span>
<span class="sd">            | Whatever requested as determined by the string in :out:</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">LID</span> <span class="o">=</span> <span class="n">read_lamp_data</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># parse input:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">sensor_resolution</span>
    <span class="n">sensor_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">sensor_position</span><span class="p">)</span>
    <span class="n">sensor_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sensor_n</span><span class="p">)</span>
    <span class="n">luminaire_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">luminaire_position</span><span class="p">)</span>
    <span class="n">luminaire_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">luminaire_n</span><span class="p">)</span>
    <span class="n">wall_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wall_center</span><span class="p">)</span>
    <span class="n">wall_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wall_n</span><span class="p">)</span>
    <span class="n">floor_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">floor_center</span><span class="p">)</span>
    <span class="n">floor_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">floor_n</span><span class="p">)</span>
    
    
    <span class="p">(</span><span class="n">xm_map</span><span class="p">,</span><span class="n">ym_map</span><span class="p">,</span><span class="n">zm_map</span><span class="p">,</span><span class="n">phim_map</span><span class="p">,</span><span class="n">thetam_map</span><span class="p">,</span>
        <span class="n">values_map</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_cart_lid_map</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span>
                                       <span class="n">grid_interp_method</span> <span class="o">=</span> <span class="n">grid_interp_method</span><span class="p">,</span> 
                                       <span class="n">theta_min</span> <span class="o">=</span> <span class="n">theta_min</span><span class="p">,</span> 
                                       <span class="n">angle_res</span> <span class="o">=</span> <span class="n">angle_res</span><span class="p">)</span> 
    
    
    <span class="c1"># Setup sensor:</span>
    <span class="p">(</span><span class="n">sensor_position</span><span class="p">,</span> <span class="n">sensor_corners</span><span class="p">,</span> 
     <span class="n">sensor_center</span><span class="p">,</span> <span class="n">sensor_n</span><span class="p">,</span> 
     <span class="n">sensor_pixels</span><span class="p">,</span> <span class="n">drays</span><span class="p">)</span> <span class="o">=</span> <span class="n">_create_sensor_plane</span><span class="p">(</span><span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span><span class="p">,</span> <span class="n">Fd</span> <span class="o">=</span> <span class="n">Fd</span><span class="p">,</span> 
                                                 <span class="n">position</span> <span class="o">=</span> <span class="n">sensor_position</span><span class="p">,</span> 
                                                 <span class="n">n</span> <span class="o">=</span> <span class="n">sensor_n</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">)</span>
    
    <span class="c1"># setup wall:</span>
    <span class="n">wall_corners</span><span class="p">,</span> <span class="n">wall_n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_create_plane</span><span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">wall_width</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">wall_height</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">wall_center</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">wall_n</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="c1"># setup floor:</span>
    <span class="n">floor_corners</span><span class="p">,</span> <span class="n">floor_n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_create_plane</span><span class="p">(</span><span class="n">w</span> <span class="o">=</span> <span class="n">floor_width</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">floor_height</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">floor_center</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">floor_n</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Trace rays from viewpoint (0,0,0) through camera pixels and calculate</span>
    <span class="c1"># the intersection points with the wall(s) and floor:</span>
    <span class="n">intersectionpoints_wall</span><span class="p">,</span> <span class="n">dist_sensor_wall</span> <span class="o">=</span> <span class="n">_get_line_plane_intersection</span><span class="p">(</span><span class="n">sensor_position</span><span class="p">,</span><span class="n">drays</span><span class="p">,</span> <span class="n">wall_center</span><span class="p">,</span> <span class="n">wall_n</span><span class="p">,</span> <span class="n">wall_corners</span><span class="p">)</span>
    <span class="n">intersectionpoints_floor</span><span class="p">,</span> <span class="n">dist_sensor_floor</span> <span class="o">=</span> <span class="n">_get_line_plane_intersection</span><span class="p">(</span><span class="n">sensor_position</span><span class="p">,</span><span class="n">drays</span><span class="p">,</span> <span class="n">floor_center</span><span class="p">,</span> <span class="n">floor_n</span><span class="p">,</span> <span class="n">floor_corners</span><span class="p">)</span>

    <span class="c1"># Get luminance values for wall and floor:</span>
    <span class="n">L_wall</span><span class="p">,</span><span class="n">luminaire_n_</span><span class="p">,</span> <span class="n">dist_source_wall</span><span class="p">,</span> <span class="p">(</span><span class="n">xm_map_r</span><span class="p">,</span><span class="n">ym_map_r</span><span class="p">,</span><span class="n">zm_map_r</span><span class="p">)</span> <span class="o">=</span> <span class="n">_get_plane_luminance</span><span class="p">(</span><span class="n">plum</span> <span class="o">=</span> <span class="n">luminaire_position</span><span class="p">,</span> <span class="n">nlum</span> <span class="o">=</span> <span class="n">luminaire_n</span><span class="p">,</span> <span class="n">lid</span> <span class="o">=</span> <span class="n">LID</span><span class="p">,</span> <span class="n">pplane</span> <span class="o">=</span> <span class="n">intersectionpoints_wall</span><span class="p">,</span> <span class="n">nplane</span> <span class="o">=</span> <span class="n">wall_n</span><span class="p">,</span> <span class="n">psensor</span> <span class="o">=</span> <span class="n">sensor_position</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">wall_rho</span><span class="p">,</span> <span class="n">xyzm_maps</span><span class="o">=</span><span class="p">(</span><span class="n">xm_map</span><span class="p">,</span><span class="n">ym_map</span><span class="p">,</span><span class="n">zm_map</span><span class="p">))</span>
    <span class="n">L_floor</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dist_source_floor</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_get_plane_luminance</span><span class="p">(</span><span class="n">plum</span> <span class="o">=</span> <span class="n">luminaire_position</span><span class="p">,</span> <span class="n">nlum</span> <span class="o">=</span> <span class="n">luminaire_n</span><span class="p">,</span> <span class="n">lid</span> <span class="o">=</span> <span class="n">LID</span><span class="p">,</span> <span class="n">pplane</span> <span class="o">=</span> <span class="n">intersectionpoints_floor</span><span class="p">,</span> <span class="n">nplane</span> <span class="o">=</span> <span class="n">floor_n</span><span class="p">,</span> <span class="n">psensor</span> <span class="o">=</span> <span class="n">sensor_position</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">floor_rho</span><span class="p">,</span> <span class="n">xyzm_maps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Pool wall and floor intersection points and luminance values:</span>
    <span class="n">intersectionpoints</span> <span class="o">=</span> <span class="n">intersectionpoints_wall</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
    <span class="n">Lvs</span> <span class="o">=</span> <span class="n">L_wall</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist_sensor_floor</span> <span class="o">&lt;=</span> <span class="n">dist_sensor_wall</span><span class="p">)</span>
    <span class="n">intersectionpoints</span><span class="p">[</span><span class="n">cond</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">intersectionpoints_floor</span><span class="p">[</span><span class="n">cond</span><span class="p">,:]</span>
    <span class="n">Lvs</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="n">L_floor</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span>
    
    <span class="c1"># check occlusion of floor by wall with respect to source:</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dist_source_floor</span> <span class="o">&gt;</span> <span class="n">dist_source_wall</span><span class="p">)</span>  <span class="c1"># also check distance to source</span>
    <span class="n">intersectionpoints</span><span class="p">[</span><span class="n">cond</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">Lvs</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="n">Lvs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Lvs</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># were non-intersecting or blocked rays (only 1 bounce !!!)</span>
    <span class="n">maxL</span> <span class="o">=</span> <span class="n">Lvs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">Lv2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Lvs</span><span class="p">,(</span><span class="n">res</span><span class="p">,</span><span class="n">res</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    

    <span class="c1"># Make plots:</span>
    <span class="k">if</span> <span class="n">ax3D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig3D</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">join_axes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ax2D</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> 
                <span class="n">ax3D</span> <span class="o">=</span> <span class="n">fig3D</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax3D</span> <span class="o">=</span> <span class="n">fig3D</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
                <span class="n">ax2D</span> <span class="o">=</span> <span class="n">fig3D</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax3D</span> <span class="o">=</span> <span class="n">fig3D</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax2D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig2D</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax2D</span> <span class="o">=</span> <span class="n">fig2D</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax3D</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plot_luminaire_position</span><span class="p">:</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="mf">1.2</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;luminaire&#39;</span><span class="p">)</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">luminaire_n_</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">luminaire_n_</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">luminaire_n_</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;y-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_sensor_pixels</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sensor_pixels</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">sensor_pixels</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">sensor_pixels</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;g.&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sensor pixels&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_sensor_position</span><span class="p">:</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sensor focal point&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">sensor_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">sensor_n</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">sensor_n</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_sensor_rays</span><span class="p">:</span>
            <span class="c1"># for i in range(sensor_pixels.shape[0]):</span>
            <span class="c1">#     ax3D.plot(np.vstack((sensor_pixels[i,0],sensor_position[:,0]))[:,0],</span>
            <span class="c1">#             np.vstack((sensor_pixels[i,1],sensor_position[:,1]))[:,0],</span>
            <span class="c1">#             np.vstack((sensor_pixels[i,2],sensor_position[:,2]))[:,0],&#39;g.-&#39;) </span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drays</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;c.:&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;sensor rays&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">sensor_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;c.:&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span> 
        
        <span class="k">if</span> <span class="n">plot_lumiaire_rays</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">drays_</span> <span class="o">=</span> <span class="n">intersectionpoints</span> <span class="o">-</span> <span class="n">luminaire_position</span>
            <span class="n">drays_</span> <span class="o">=</span> <span class="n">drays_</span><span class="o">/</span><span class="n">_norm</span><span class="p">(</span><span class="n">drays_</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drays_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;y.:&#39;</span><span class="p">,</span><span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;luminaire rays&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">t</span><span class="o">*</span><span class="n">drays_</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="n">luminaire_position</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;y.:&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">plot_luminaire_lid</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xm_map_r</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">ym_map_r</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">zm_map_r</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">c</span><span class="o">=</span><span class="n">values_map</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
                    
        <span class="k">if</span> <span class="n">plot_wall_intersections</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;wall-ray intersection&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_floor_intersections</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;mo&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;floor-ray intersections&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_wall_edges</span><span class="p">:</span>
            <span class="n">_plot_plane_edges</span><span class="p">(</span><span class="n">wall_corners</span><span class="p">,</span> <span class="n">ax3D</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;b.&#39;</span><span class="p">)</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">wall_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">wall_n</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">wall_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">wall_n</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;b-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_floor_edges</span><span class="p">:</span>
            <span class="n">_plot_plane_edges</span><span class="p">(</span><span class="n">floor_corners</span><span class="p">,</span> <span class="n">ax3D</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="n">dv</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s1">&#39;m.&#39;</span><span class="p">)</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">floor_n</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">floor_n</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">floor_center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">floor_n</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[:,</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;m-&#39;</span><span class="p">,</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">plot_wall_luminance</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">intersectionpoints_wall</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="n">L_wall</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_floor_luminance</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">intersectionpoints_floor</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">c</span> <span class="o">=</span> <span class="n">L_floor</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend_on</span><span class="p">:</span>
            <span class="n">ax3D</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="n">ax2D</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ax2D</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Lv2D</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">maxL</span><span class="p">)</span>
        <span class="n">ax2D</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax2D</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

    
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    
    <span class="c1"># Read lamp data from IES file:</span>
    <span class="n">LID</span> <span class="o">=</span> <span class="n">read_lamp_data</span><span class="p">(</span><span class="s1">&#39;./data/luxpy_test_lid_file.ies&#39;</span><span class="p">,</span> <span class="n">verbosity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#LID = read_lamp_data(&#39;./data/luxpy_test_lid_file.ldt&#39;, verbosity = 1)</span>
    
    <span class="c1"># # Generate uv-map for rendering / ray-tracing (eg by wrapping this around </span>
    <span class="c1"># # a point light source to attenuate the luminous intensity in different directions):</span>
    <span class="c1"># uv_map = get_uv_texture(theta = LID[&#39;map&#39;][&#39;theta&#39;], </span>
    <span class="c1">#                           phi = LID[&#39;map&#39;][&#39;phi&#39;], </span>
    <span class="c1">#                           values = LID[&#39;map&#39;][&#39;values&#39;], </span>
    <span class="c1">#                           input_types = (&#39;array&#39;,&#39;mesh&#39;), </span>
    <span class="c1">#                           method = &#39;linear&#39;, </span>
    <span class="c1">#                           theta_min = 0, angle_res = 1,</span>
    <span class="c1">#                           deg = True, r = 1, </span>
    <span class="c1">#                           show = True)</span>
    <span class="c1"># plt.figure()</span>
    <span class="c1"># plt.imshow(uv_map)</span>
    
    
    <span class="c1"># draw 2D polar plot of C0-C180 and C90-C270 planes::</span>
    <span class="n">draw_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">)</span>

    <span class="c1"># draw 2D polar plot of C0-C180, C45-C225 and C90-C270 planes::</span>
    <span class="n">draw_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">polar_plot_Cx_planes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">90</span><span class="p">])</span>
    

    <span class="c1"># draw 3D LID:</span>
    <span class="n">draw_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">)</span>    
    
    <span class="c1"># # # Render LID</span>
    <span class="c1"># Lv2D = render_lid(LID, sensor_resolution = 40,</span>
    <span class="c1">#                     sensor_position = [0,-1,0.8], sensor_n = [0,1,-0.2], fov = (90,90), Fd = 2,</span>
    <span class="c1">#                     luminaire_position = [0,1.3,2], luminaire_n = [0,0,-1],</span>
    <span class="c1">#                     wall_center = [0,2,1], wall_n = [0,-1,0], wall_width = 4, wall_height = 2, wall_rho = 1,</span>
    <span class="c1">#                     floor_center = [0,1,0], floor_n = [0,0,1], floor_width = 4, floor_height = 2, floor_rho = 1,</span>
    <span class="c1">#                     ax3D = None, ax2D = None, join_axes = False, </span>
    <span class="c1">#                     plot_luminaire_position = True, plot_lumiaire_rays = False, plot_luminaire_lid = True,</span>
    <span class="c1">#                     plot_sensor_position = True, plot_sensor_pixels = False, plot_sensor_rays = False, </span>
    <span class="c1">#                     plot_wall_edges = True, plot_wall_luminance = True, plot_wall_intersections = False,</span>
    <span class="c1">#                     plot_floor_edges = True, plot_floor_luminance = True, plot_floor_intersections = False,</span>
    <span class="c1">#                     out = &#39;Lv2D&#39;)</span>
    
    <span class="c1"># or combine draw and render (but use only 2D image):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">])</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;polar&#39;</span><span class="p">),</span>
           <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">),</span> 
           <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">,</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">),</span>
           <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)]</span>
    <span class="n">draw_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">draw_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">projection</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">Lv2D</span> <span class="o">=</span> <span class="n">render_lid</span><span class="p">(</span><span class="n">LID</span><span class="p">,</span> <span class="n">sensor_resolution</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">sensor_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.8</span><span class="p">],</span> <span class="n">sensor_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mf">0.2</span><span class="p">],</span> <span class="n">fov</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">),</span> <span class="n">Fd</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="n">luminaire_position</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.3</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">luminaire_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">wall_center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">wall_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">wall_width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wall_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wall_rho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">floor_center</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">floor_n</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">floor_width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">floor_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">floor_rho</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">ax3D</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax2D</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">join_axes</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                        <span class="n">plot_luminaire_position</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_lumiaire_rays</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_luminaire_lid</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="n">plot_sensor_position</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_sensor_pixels</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">plot_sensor_rays</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                        <span class="n">plot_wall_edges</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_wall_luminance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_wall_intersections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">plot_floor_edges</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_floor_luminance</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">plot_floor_intersections</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Lv2D&#39;</span><span class="p">)</span>
    <span class="c1"># Lv2D = render_lid(LID, ax3D = False)</span>
    
    
    
    

        
    
        
  
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Kevin A.G. Smet.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>